import React, { useState, useMemo, useEffect, useRef } from 'react';
import { 
  Line, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer, 
  BarChart, Bar, Legend, AreaChart, Area, ComposedChart, ReferenceLine
} from 'recharts';
import { 
  Calculator, DollarSign, Settings, ChevronDown, ChevronUp, Save, 
  TrendingUp, Package, CreditCard, ShoppingCart, Edit2, Plus, X, Trash2, Box, 
  Users, Briefcase, Building, Lightbulb, Minus, Server, Shield, Wifi, FileText, 
  Landmark, Wallet, Activity, Download, Upload, FileSpreadsheet, PieChart as PieIcon 
} from 'lucide-react';

/* ---------------------------------------------------------------------
   DATA & INITIAL STATE
   --------------------------------------------------------------------- */

const INITIAL_PRODUCTS = [
  // AGREEMENT
  { 
    id: 'small_agreement',  
    baseId: 'sys_small', 
    name: 'AlphaPWR Small',  
    type: 'Agreement', 
    model: 'Abonnement',  
    priceOneOff: 18250,   
    priceMonthly: 3200,
    cost: 25000, 
    image: "https://storage.googleapis.com/files_webpage/Small%20Transparent.png"
  },
  { 
    id: 'medium_agreement', 
    baseId: 'sys_medium',
    name: 'AlphaPWR Medium', 
    type: 'Agreement', 
    model: 'Abonnement',  
    priceOneOff: 22500,  
    priceMonthly: 3890,
    cost: 44000, 
    image: "https://storage.googleapis.com/files_webpage/Medium%20Transparent.png"
  },
  { 
    id: 'double_agreement', 
    baseId: 'sys_double',
    name: 'AlphaPWR Double', 
    type: 'Agreement', 
    model: 'Abonnement',  
    priceOneOff: 42500,  
    priceMonthly: 7000,
    cost: 87000, 
    image: "https://storage.googleapis.com/files_webpage/Large%20Transparent.png"
  },
  
  // PURCHASE
  { 
    id: 'small_purchase',   
    baseId: 'sys_small', 
    name: 'AlphaPWR Small',  
    type: 'Purchase',  
    model: 'Kjøp',        
    priceOneOff: 140000, 
    priceMonthly: 950,
    cost: 25000, 
    image: "https://storage.googleapis.com/files_webpage/Small%20Transparent.png"
  },
  { 
    id: 'medium_purchase',  
    baseId: 'sys_medium',
    name: 'AlphaPWR Medium', 
    type: 'Purchase',  
    model: 'Kjøp',        
    priceOneOff: 170000,
    priceMonthly: 950,
    cost: 44000, 
    image: "https://storage.googleapis.com/files_webpage/Medium%20Transparent.png"
  },
  { 
    id: 'double_purchase',  
    baseId: 'sys_double',
    name: 'AlphaPWR Double', 
    type: 'Purchase',  
    model: 'Kjøp',        
    priceOneOff: 320000,
    priceMonthly: 950,
    cost: 87000, 
    image: "https://storage.googleapis.com/files_webpage/Large%20Transparent.png"
  },
  
  // ADDONS
  { 
    id: 'addon_nordic',     
    baseId: 'addon_nordic',
    name: 'Nordic Hamstring',
    type: 'Addon',     
    model: 'Tillegg',     
    priceOneOff: 20000,  
    priceMonthly: 250,
    cost: 10000, 
    image: "https://storage.googleapis.com/files_webpage/Nordic%20Hamstring%205.png"
  },
  { 
    id: 'addon_pull',       
    baseId: 'addon_pull',
    name: 'Pull Håndtak',    
    type: 'Addon',     
    model: 'Tillegg',     
    priceOneOff: 2450,    
    priceMonthly: 0,
    cost: 2000, 
    image: "https://storage.googleapis.com/files_webpage/Pull.png"
  },
];

const INITIAL_STAFF = [
  { id: 'role_sales', name: 'Salg', salary: 750000, socialCostFactor: 1.4 },
  { id: 'role_rnd', name: 'R&D', salary: 850000, socialCostFactor: 1.4 },
  { id: 'role_support', name: 'Support', salary: 700000, socialCostFactor: 1.4 },
  { id: 'role_management', name: 'Ledelse', salary: 800000, socialCostFactor: 1.4 },
  { id: 'role_marketing', name: 'Markedsføring', salary: 750000, socialCostFactor: 1.4 },
  { id: 'role_logistics', name: 'Logistikk', salary: 850000, socialCostFactor: 1.4 },
  { id: 'role_board', name: 'Styremedlem', salary: 50000, socialCostFactor: 1.3 },
];

const INITIAL_CONSULTANTS = [
  { id: 'cons_matre', name: 'Matre konsulenttjenester', monthlyRate: 12500 },
];

const INITIAL_OTHER_COSTS = [
  { id: 'cost_office', name: 'Kontorleie', monthlyCost: 7500, icon: Building },
  { id: 'cost_cloud', name: 'Server & Cloud', monthlyCost: 2500, variablePerUnit: 20, icon: Server },
  { id: 'cost_insurance', name: 'Forsikring', monthlyCost: 3000, icon: Shield },
  { id: 'cost_electricity', name: 'Strøm', monthlyCost: 2500, icon: Lightbulb },
  { id: 'cost_internet', name: 'Internett & Telefon', monthlyCost: 1500, icon: Wifi },
  { id: 'cost_software', name: 'Programvare', monthlyCost: 2000, icon: Package },
  { id: 'cost_accounting', name: 'Regnskap', monthlyCost: 7000, icon: Calculator },
  { id: 'cost_audit', name: 'Revisjon', monthlyCost: 1250, icon: FileText }, 
  { id: 'cost_marketing', name: 'Markedsføring', monthlyCost: 12500, icon: TrendingUp },
  { id: 'cost_car', name: 'Firmabil', monthlyCost: 5833, icon: ShoppingCart },
  { id: 'cost_rnd_exp', name: 'R&D Utgifter', monthlyCost: 5000, icon: Settings },
  { id: 'cost_patent', name: 'Patent', monthlyCost: 3500, icon: Shield },
  { id: 'cost_courses', name: 'Kurs og opplæring', monthlyCost: 1200, icon: Users },
  { id: 'cost_travel', name: 'Reisekostnader', monthlyCost: 15000, icon: Briefcase },
  { id: 'cost_other', name: 'Annet', monthlyCost: 5000, icon: Box },
];

const INITIAL_LOANS = [
  {
    id: 'loan_innovation',
    name: 'Innovasjon Norge Lån',
    amount: 2000000,
    startMonth: 0, // Jan
    interestRate: 7.7,
    termYears: 7,
    gracePeriodMonths: 0, // Avdragsfri periode
    establishmentFeeRate: 0.5,
    isActive: true 
  }
];

const INITIAL_EQUITY = [
  {
    id: 'eq_1',
    name: 'Første runde',
    amount: 0,
    month: 0,
    isActive: true
  }
];

const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Des'];

/* ---------------------------------------------------------------------
   HJELPEFUNKSJONER
   --------------------------------------------------------------------- */

// Tryggere aritmetikk for å unngå 0.1 + 0.2 = 0.30000000004 problemer
const safeFloat = (num) => {
  return Math.round((num + Number.EPSILON) * 10000) / 10000;
};

const formatNOK = (value) => {
  return new Intl.NumberFormat('no-NO', {
    style: 'currency',
    currency: 'NOK',
    maximumFractionDigits: 0
  }).format(value);
};

const formatCompactNOK = (value) => {
  return new Intl.NumberFormat('no-NO', {
    style: 'currency',
    currency: 'NOK',
    notation: 'compact',
    maximumFractionDigits: 1
  }).format(value);
};

/* ---------------------------------------------------------------------
   KOMPONENTER
   --------------------------------------------------------------------- */

const Card = ({ children, className = "" }) => (
  <div className={`bg-zinc-900/80 backdrop-blur-sm border border-zinc-800 rounded-lg p-6 shadow-sm ${className}`}>
    {children}
  </div>
);

const InputField = ({ value, onChange, placeholder, className = "", step="1" }) => (
  <input
    type="number"
    min="0"
    step={step}
    className={`w-full bg-zinc-950 border border-zinc-800 rounded px-2 py-1.5 text-zinc-200 placeholder-zinc-600 focus:outline-none focus:ring-1 focus:ring-zinc-500 focus:border-zinc-500 transition-all text-right font-mono text-sm ${className}`}
    value={value === 0 ? '' : value}
    onChange={onChange}
    onWheel={(e) => e.target.blur()} // Forhindrer scroll-endring
    placeholder={placeholder}
  />
);

const TabButton = ({ active, onClick, icon: Icon, label }) => (
  <button
    onClick={onClick}
    className={`flex items-center gap-2 px-5 py-2.5 rounded-md text-sm font-medium transition-all duration-200 ${
      active 
        ? 'bg-zinc-100 text-zinc-900 shadow-sm' 
        : 'text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800/50'
    }`}
  >
    <Icon size={16} />
    {label}
  </button>
);

const EditProductModal = ({ product, isOpen, onClose, onSave, onDelete }) => {
  const [formData, setFormData] = useState(product || { name: '', priceOneOff: 0, priceMonthly: 0, cost: 0 });

  React.useEffect(() => {
    if (product) setFormData(product);
    else setFormData({ name: '', priceOneOff: 0, priceMonthly: 0, cost: 0, type: 'Agreement' });
  }, [product]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
      <div className="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-md p-6 shadow-2xl animate-in fade-in zoom-in duration-200">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-lg font-semibold text-zinc-100">
            {product && product.id ? 'Rediger Produkt' : 'Nytt Produkt'}
          </h3>
          <button onClick={onClose} className="p-2 hover:bg-zinc-800 rounded-full transition-colors">
            <X size={18} className="text-zinc-400" />
          </button>
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-xs uppercase text-zinc-500 mb-1 font-semibold">Produktnavn</label>
            <input 
              className="w-full bg-zinc-950 border border-zinc-800 rounded-md px-3 py-2 text-zinc-200 focus:outline-none focus:border-zinc-600"
              value={formData.name}
              onChange={e => setFormData({...formData, name: e.target.value})}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs uppercase text-zinc-500 mb-1 font-semibold">Engangspris (Ut)</label>
              <input 
                type="number"
                className="w-full bg-zinc-950 border border-zinc-800 rounded-md px-3 py-2 text-zinc-200 focus:outline-none focus:border-zinc-600"
                value={formData.priceOneOff}
                onWheel={(e) => e.target.blur()}
                onChange={e => setFormData({...formData, priceOneOff: parseFloat(e.target.value) || 0})}
              />
            </div>
            <div>
              <label className="block text-xs uppercase text-zinc-500 mb-1 font-semibold">Månedspris (Ut)</label>
              <input 
                 type="number"
                 className="w-full bg-zinc-950 border border-zinc-800 rounded-md px-3 py-2 text-zinc-200 focus:outline-none focus:border-zinc-600"
                 value={formData.priceMonthly}
                 onWheel={(e) => e.target.blur()}
                 onChange={e => setFormData({...formData, priceMonthly: parseFloat(e.target.value) || 0})}
              />
            </div>
          </div>

           <div>
              <label className="block text-xs uppercase text-zinc-500 mb-1 font-semibold">Varekost (COGS)</label>
              <input 
                 type="number"
                 className="w-full bg-zinc-950 border border-red-900/20 rounded-md px-3 py-2 text-zinc-200 focus:outline-none focus:border-red-900/50"
                 value={formData.cost}
                 onWheel={(e) => e.target.blur()}
                 onChange={e => setFormData({...formData, cost: parseFloat(e.target.value) || 0})}
              />
              <p className="text-[10px] text-zinc-500 mt-1">
                Kostnad per enhet.
              </p>
            </div>
        </div>

        <div className="flex gap-3 mt-8">
          {product && product.id && (
            <button 
              onClick={() => onDelete(product.id)}
              className="px-4 py-2 rounded-md bg-red-900/20 text-red-400 border border-red-900/30 hover:bg-red-900/30 transition-colors flex items-center justify-center"
            >
              <Trash2 size={16} />
            </button>
          )}
          <button 
            onClick={() => onSave(formData)}
            className="flex-1 bg-zinc-100 hover:bg-zinc-200 text-zinc-900 font-medium rounded-md py-2 transition-colors"
          >
            Lagre Endringer
          </button>
        </div>
      </div>
    </div>
  );
};

const LoanSettingsModal = ({ loan, isOpen, onClose, onSave }) => {
  const [formData, setFormData] = useState(loan || {});

  React.useEffect(() => {
    if (loan) setFormData(loan);
  }, [loan]);

  if (!isOpen || !loan) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
      <div className="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-md p-6 shadow-2xl animate-in fade-in zoom-in duration-200">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-lg font-semibold text-zinc-100 flex items-center gap-2">
            <Landmark className="text-zinc-400" size={20}/>
            Innstillinger for {loan.name}
          </h3>
          <button onClick={onClose} className="p-2 hover:bg-zinc-800 rounded-full transition-colors">
            <X size={18} className="text-zinc-400" />
          </button>
        </div>

        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs uppercase text-zinc-500 mb-1 font-semibold">Nominell Rente (%)</label>
              <input 
                type="number" step="0.1"
                className="w-full bg-zinc-950 border border-zinc-800 rounded-md px-3 py-2 text-zinc-200 focus:outline-none focus:border-zinc-600"
                value={formData.interestRate}
                onWheel={(e) => e.target.blur()}
                onChange={e => setFormData({...formData, interestRate: parseFloat(e.target.value) || 0})}
              />
            </div>
            <div>
              <label className="block text-xs uppercase text-zinc-500 mb-1 font-semibold">Etableringsgebyr (%)</label>
              <input 
                 type="number" step="0.1"
                 className="w-full bg-zinc-950 border border-zinc-800 rounded-md px-3 py-2 text-zinc-200 focus:outline-none focus:border-zinc-600"
                 value={formData.establishmentFeeRate}
                 onWheel={(e) => e.target.blur()}
                 onChange={e => setFormData({...formData, establishmentFeeRate: parseFloat(e.target.value) || 0})}
              />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs uppercase text-zinc-500 mb-1 font-semibold">Løpetid (År)</label>
              <input 
                type="number"
                className="w-full bg-zinc-950 border border-zinc-800 rounded-md px-3 py-2 text-zinc-200 focus:outline-none focus:border-zinc-600"
                value={formData.termYears}
                onWheel={(e) => e.target.blur()}
                onChange={e => setFormData({...formData, termYears: parseFloat(e.target.value) || 0})}
              />
            </div>
            <div>
              <label className="block text-xs uppercase text-zinc-500 mb-1 font-semibold">Avdragsfri (Mnd)</label>
              <input 
                 type="number"
                 className="w-full bg-zinc-950 border border-zinc-800 rounded-md px-3 py-2 text-zinc-200 focus:outline-none focus:border-zinc-600"
                 value={formData.gracePeriodMonths}
                 onWheel={(e) => e.target.blur()}
                 onChange={e => setFormData({...formData, gracePeriodMonths: parseFloat(e.target.value) || 0})}
              />
            </div>
          </div>
          
          <p className="text-xs text-zinc-500 mt-2 p-2 bg-white/5 rounded border border-white/5">
            Lånebeløp og utbetalingsdato endres under fanen <strong>Likviditet</strong>.
          </p>
        </div>

        <div className="mt-8">
          <button 
            onClick={() => onSave(formData)}
            className="w-full bg-zinc-100 hover:bg-zinc-200 text-zinc-900 font-medium rounded-md py-2 transition-colors"
          >
            Oppdater Betingelser
          </button>
        </div>
      </div>
    </div>
  );
};

const ProductTable = ({ products, expandedRows, toggleRow, salesData, handleMonthlyChange, title, icon: Icon, headerColor, onEdit, onAdd, type }) => {
  const subTotalOneOff = products.reduce((acc, p) => {
      const months = salesData[p.id] || Array(12).fill(0);
      const units = months.reduce((a, b) => a + b, 0);
      return acc + (units * p.priceOneOff);
  }, 0);

  const subTotalARR = products.reduce((acc, p) => {
      const months = salesData[p.id] || Array(12).fill(0);
      const units = months.reduce((a, b) => a + b, 0);
      return acc + (units * p.priceMonthly * 12);
  }, 0);

  return (
    <Card className="overflow-hidden h-full flex flex-col">
      <div className="flex justify-between items-center mb-6 pb-4 border-b border-zinc-800">
        <h2 className={`text-lg font-semibold flex items-center gap-2 text-zinc-100`}>
          <Icon size={20} className="text-zinc-400" />
          {title}
        </h2>
        <div className="text-right">
           <div className="text-[10px] text-zinc-500 uppercase tracking-wider font-bold">Total Verdi</div>
           <div className="font-mono text-sm text-zinc-300">{formatNOK(subTotalOneOff + subTotalARR)}</div>
        </div>
      </div>

      <div className="overflow-x-auto -mx-6 px-6 pb-4 flex-grow">
        <table className="w-full text-left border-collapse">
          <thead>
            <tr className="border-b border-zinc-800 text-zinc-500 text-xs uppercase tracking-wider">
              <th className="py-2 pl-2 w-8"></th>
              <th className="py-2 font-medium w-64">Produkt</th>
              <th className="py-2 text-right font-medium">Pris</th>
              <th className="py-2 text-right font-medium text-zinc-300">Antall</th>
              <th className="py-2 text-right font-medium hidden sm:table-cell">Engangsverdi</th>
              <th className="py-2 text-right font-medium hidden sm:table-cell">Årlig Verdi</th>
              <th className="py-2 w-10"></th>
            </tr>
          </thead>
          <tbody className="divide-y divide-zinc-800/50">
            {products.map((row) => {
               const months = salesData[row.id] || Array(12).fill(0);
               const totalUnits = months.reduce((a, b) => a + b, 0);
               const rowValOneOff = totalUnits * row.priceOneOff;
               const rowValARR = totalUnits * row.priceMonthly * 12;

               return (
              <React.Fragment key={row.id}>
                <tr 
                  className={`transition-colors group ${
                    expandedRows[row.id] ? 'bg-zinc-800/30' : 'hover:bg-zinc-800/30'
                  }`}
                >
                  <td className="py-3 pl-2 text-zinc-600 cursor-pointer" onClick={() => toggleRow(row.id)}>
                      {expandedRows[row.id] ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                  </td>
                  <td className="py-3 font-medium text-zinc-200 cursor-pointer" onClick={() => toggleRow(row.id)}>
                    <div className="flex items-center gap-3">
                      {row.image ? (
                        <div className="w-8 h-8 bg-zinc-800 rounded p-1 flex items-center justify-center border border-zinc-700 shrink-0">
                          <img src={row.image} alt={row.name} className="max-w-full max-h-full object-contain" />
                        </div>
                      ) : (
                        <div className="w-8 h-8 bg-zinc-800 rounded flex items-center justify-center border border-zinc-700 shrink-0">
                           <Package size={14} className="text-zinc-500"/>
                        </div>
                      )}
                      <div className="flex flex-col">
                        <span>{row.name}</span>
                      </div>
                    </div>
                  </td>
                  <td className="py-3 text-right text-xs text-zinc-400 font-mono cursor-pointer" onClick={() => toggleRow(row.id)}>
                    <div>{formatCompactNOK(row.priceOneOff)}</div>
                    {row.priceMonthly > 0 && <div className="text-zinc-500">+{formatCompactNOK(row.priceMonthly)}/mnd</div>}
                  </td>
                  <td className="py-3 text-right cursor-pointer" onClick={() => toggleRow(row.id)}>
                    <span className="font-bold text-lg text-zinc-100">{totalUnits}</span>
                  </td>
                  <td className="py-3 text-right font-mono text-sm text-zinc-400 hidden sm:table-cell cursor-pointer" onClick={() => toggleRow(row.id)}>
                    {rowValOneOff > 0 ? formatCompactNOK(rowValOneOff) : '-'}
                  </td>
                  <td className="py-3 text-right font-mono text-sm text-zinc-400 hidden sm:table-cell cursor-pointer" onClick={() => toggleRow(row.id)}>
                    {rowValARR > 0 ? formatCompactNOK(rowValARR) : '-'}
                  </td>
                  
                  <td className="py-3 pr-2 text-right">
                    <button 
                      onClick={(e) => { e.stopPropagation(); onEdit(row); }}
                      className="p-1.5 rounded-full hover:bg-zinc-700 text-zinc-500 hover:text-zinc-200 transition-colors"
                    >
                      <Settings size={14} />
                    </button>
                  </td>
                </tr>
                
                {expandedRows[row.id] && (
                  <tr className="bg-zinc-900/50 shadow-inner">
                    <td colSpan="7" className="p-3">
                      <div className="bg-zinc-950/50 rounded-lg border border-zinc-800 p-3 animate-in slide-in-from-top-2 duration-200">
                        <h4 className="text-[10px] uppercase text-zinc-500 font-semibold tracking-wider mb-2">
                          Fordel salg på måneder
                        </h4>
                        <div className="grid grid-cols-6 md:grid-cols-12 gap-2">
                          {MONTHS.map((m, idx) => (
                            <div key={m} className="flex flex-col gap-1">
                              <label className="text-[9px] text-zinc-500 uppercase text-center">{m}</label>
                              <InputField 
                                value={months[idx]} 
                                onChange={(e) => handleMonthlyChange(row.id, idx, e.target.value)}
                                placeholder="0"
                                className="text-center bg-zinc-900 focus:bg-zinc-800 text-xs py-1"
                              />
                            </div>
                          ))}
                        </div>
                      </div>
                    </td>
                  </tr>
                )}
              </React.Fragment>
            )})}
          </tbody>
        </table>
      </div>
      
      <div className="mt-4 pt-4 border-t border-zinc-800">
        <button 
          onClick={() => onAdd(type)}
          className="flex items-center gap-2 text-xs font-medium text-zinc-400 hover:text-white transition-colors px-2 py-1 rounded hover:bg-white/5 w-fit"
        >
          <Plus size={14} /> Legg til produkt
        </button>
      </div>
    </Card>
  );
};

/* ---------------------------------------------------------------------
   VARIABLE KOSTNADER COMPONENT
   --------------------------------------------------------------------- */

const VariableCostsTab = ({ costCalculation, stockData, setStockData, onUpdateCost }) => {
  return (
    <div className="space-y-8">
       <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <Card>
            <h3 className="text-zinc-400 text-xs uppercase tracking-wider font-bold">Est. Varekostnad (COGS) 2026</h3>
            <div className="text-3xl font-bold mt-2 text-zinc-100">{formatNOK(costCalculation.totalVariableCost)}</div>
            <div className="text-xs text-zinc-500 mt-1">Kostnad for solgte varer (Regnskapsmessig)</div>
          </Card>
           <Card>
            <div className="h-[120px] w-full">
              <ResponsiveContainer width="100%" height="100%">
                 <BarChart data={costCalculation.graphData}>
                   <Bar dataKey="Kostnad" fill="#f87171" radius={[2,2,0,0]} />
                   <XAxis dataKey="name" hide />
                   <RechartsTooltip 
                     cursor={{fill: '#ffffff05'}}
                     contentStyle={{ backgroundColor: '#18181b', border: '1px solid #27272a', borderRadius: '6px' }}
                     formatter={(value) => [formatCompactNOK(value), 'Innkjøp']}
                   />
                 </BarChart>
              </ResponsiveContainer>
            </div>
            <div className="text-center text-xs text-zinc-500 mt-2">Månedlig varekjøp (Likviditetseffekt)</div>
          </Card>
       </div>

      <Card>
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
            <Package className="text-zinc-400" size={20}/>
            Varelager & Innkjøp (Batch: 10, Lead: 60 dager)
          </h2>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="border-b border-zinc-800 text-zinc-500 text-xs uppercase tracking-wider">
                <th className="py-4 pl-4 font-medium">Fysisk Produkt</th>
                <th className="py-4 text-right font-medium">Enhetskost</th>
                <th className="py-4 text-right font-medium">Lager (Start)</th>
                <th className="py-4 text-right font-medium text-zinc-300">Totalt Salg</th>
                <th className="py-4 text-right font-medium text-zinc-300">Antall Kjøpt Inn</th>
                <th className="py-4 pr-4 text-right font-medium text-zinc-300">Bokført COGS</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-zinc-800/50">
              {costCalculation.productBreakdown.map((p) => (
                <tr key={p.stockKey} className="hover:bg-zinc-800/30 transition-colors">
                  <td className="py-4 pl-4 font-medium text-zinc-200">
                    <div className="flex items-center gap-3">
                       {p.image && (
                          <div className="w-8 h-8 bg-zinc-800 rounded p-1 flex items-center justify-center border border-zinc-700 shrink-0">
                            <img src={p.image} alt={p.name} className="max-w-full max-h-full object-contain" />
                          </div>
                        )}
                        <div>
                           <span>{p.name}</span>
                           <div className="text-[10px] text-zinc-500">Inkl. Abonnement & Kjøp</div>
                        </div>
                    </div>
                  </td>
                  <td className="py-4 text-right">
                    <div className="flex items-center justify-end gap-2 group">
                      <span className="font-mono text-sm text-zinc-400">{formatCompactNOK(p.cost)}</span>
                      <button 
                        onClick={() => onUpdateCost(p)}
                        className="opacity-0 group-hover:opacity-100 p-1 hover:bg-zinc-700 rounded transition-opacity"
                        title="Endre kostnad for dette fysiske produktet"
                      >
                        <Edit2 size={12} className="text-zinc-500"/>
                      </button>
                    </div>
                  </td>
                  <td className="py-4 text-right">
                    <InputField 
                      value={stockData[p.stockKey] || 0} 
                      onChange={(e) => setStockData(prev => ({...prev, [p.stockKey]: parseInt(e.target.value) || 0}))}
                      placeholder="0"
                      className="w-20 bg-zinc-900 border-zinc-700 focus:border-zinc-500 text-zinc-200 font-bold"
                    />
                  </td>
                  <td className="py-4 text-right font-mono text-sm text-zinc-300">
                    {p.totalSales}
                  </td>
                   <td className="py-4 text-right font-mono text-sm text-zinc-100 font-bold">
                    {p.unitsProducedTotal}
                  </td>
                  <td className="py-4 pr-4 text-right font-mono font-bold text-zinc-300">
                    {formatNOK(p.costTotal)}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
};

/* ---------------------------------------------------------------------
   FASTE KOSTNADER (FIXED COSTS)
   --------------------------------------------------------------------- */

const FixedCostsTab = ({ 
    staffRoles, staffingData, 
    consultants, consultingData,
    otherCosts, loans, loanCosts, 
    fixedCostCalculations, 
    setStaffRoles, setStaffingData, setConsultants, setConsultingData, setOtherCosts, 
    onEditLoan 
  }) => {
  const [expandedRows, setExpandedRows] = useState({});

  const toggleRow = (id) => {
    setExpandedRows(prev => ({ ...prev, [id]: !prev[id] }));
  };

  const handleMonthlyStaffChange = (roleId, monthIndex, value) => {
    const newVal = parseFloat(value) || 0;
    setStaffingData(prev => {
      const currentMonths = prev[roleId] ? [...prev[roleId]] : Array(12).fill(0);
      currentMonths[monthIndex] = newVal;
      return { ...prev, [roleId]: currentMonths };
    });
  };

  const handleBulkStaffChange = (roleId, change) => {
    setStaffingData(prev => {
      const currentMonths = prev[roleId] ? [...prev[roleId]] : Array(12).fill(0);
      const newMonths = currentMonths.map(val => Math.max(0, val + change));
      return { ...prev, [roleId]: newMonths };
    });
  };

  const handleMonthlyConsultingChange = (id, monthIndex, value) => {
    const newVal = parseFloat(value) || 0;
    setConsultingData(prev => {
      const currentMonths = prev[id] ? [...prev[id]] : Array(12).fill(0);
      currentMonths[monthIndex] = newVal;
      return { ...prev, [id]: currentMonths };
    });
  };

  const handleSalaryChange = (roleId, newSalary) => {
     setStaffRoles(prev => prev.map(r => r.id === roleId ? { ...r, salary: parseInt(newSalary) || 0 } : r));
  };

  const handleSocialCostFactorChange = (roleId, newFactor) => {
    setStaffRoles(prev => prev.map(r => r.id === roleId ? { ...r, socialCostFactor: parseFloat(newFactor) || 1 } : r));
  };
  
  const handleConsultantRateChange = (id, newRate) => {
     setConsultants(prev => prev.map(c => c.id === id ? { ...c, monthlyRate: parseInt(newRate) || 0 } : c));
  };

  const handleOtherCostChange = (id, newCost) => {
    setOtherCosts(prev => prev.map(c => c.id === id ? { ...c, monthlyCost: parseInt(newCost) || 0 } : c));
  };

  return (
    <div className="space-y-8">
      
      {/* KPI & Graph */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <Card>
            <h3 className="text-zinc-400 text-xs uppercase tracking-wider font-bold">Est. Faste Kostnader 2026</h3>
            <div className="text-3xl font-bold mt-2 text-zinc-100">{formatNOK(fixedCostCalculations.totalFixedCost)}</div>
            <div className="text-xs text-zinc-500 mt-1">Lønn, Konsulenter, Drift og Finans</div>
          </Card>
           <Card>
            <div className="h-[120px] w-full">
              <ResponsiveContainer width="100%" height="100%">
                 <AreaChart data={fixedCostCalculations.graphData}>
                   <defs>
                     <linearGradient id="colorFixed" x1="0" y1="0" x2="0" y2="1">
                       <stop offset="5%" stopColor="#a1a1aa" stopOpacity={0.3}/>
                       <stop offset="95%" stopColor="#a1a1aa" stopOpacity={0}/>
                     </linearGradient>
                   </defs>
                   <Area type="monotone" dataKey="Kostnad" stroke="#a1a1aa" fill="url(#colorFixed)" />
                   <XAxis dataKey="name" hide />
                   <YAxis hide domain={[0, 'auto']} />
                   <RechartsTooltip 
                     cursor={{fill: '#ffffff05'}}
                     contentStyle={{ backgroundColor: '#18181b', border: '1px solid #27272a', borderRadius: '6px' }}
                     formatter={(value) => [formatCompactNOK(value), 'Kostnad']}
                   />
                 </AreaChart>
              </ResponsiveContainer>
            </div>
            <div className="text-center text-xs text-zinc-500 mt-2">Månedlig totalkostnad</div>
          </Card>
       </div>

      {/* 1. STAFF */}
      <Card>
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b border-zinc-800 gap-4">
          <h2 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
            <Users className="text-zinc-400" size={20}/>
            Bemanning & Lønn
          </h2>
          <div className="text-xs text-zinc-500">Merk: Feriepenger utbetales i juni.</div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="border-b border-zinc-800 text-zinc-500 text-xs uppercase tracking-wider">
                <th className="py-4 pl-4 w-8"></th>
                <th className="py-4 font-medium">Stilling / Kategori</th>
                <th className="py-4 text-right font-medium">Årslønn</th>
                <th className="py-4 text-right font-medium">Faktor</th>
                <th className="py-4 text-right font-medium text-zinc-400">Kost pr. årsverk</th>
                <th className="py-4 text-right font-medium text-zinc-300">Totale Årsverk</th>
                <th className="py-4 pr-4 text-right font-medium text-zinc-300">Total Kostnad</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-zinc-800/50">
              {fixedCostCalculations.roleBreakdown.map((role) => {
                const annualCostPerEmployee = role.salary * role.socialCostFactor;
                const totalFTEs = role.months.reduce((a, b) => a + b, 0) / 12;

                return (
                <React.Fragment key={role.id}>
                  <tr 
                    onClick={() => toggleRow(role.id)}
                    className={`cursor-pointer transition-colors group ${
                      expandedRows[role.id] ? 'bg-zinc-800/30' : 'hover:bg-zinc-800/30'
                    }`}
                  >
                    <td className="py-4 pl-4 text-zinc-600">
                       {expandedRows[role.id] ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                    </td>
                    <td className="py-4 font-medium text-zinc-200 flex items-center gap-3">
                       <div className="w-8 h-8 bg-zinc-800 rounded flex items-center justify-center border border-zinc-700 shrink-0">
                         <Briefcase size={14} className="text-zinc-400"/>
                       </div>
                       {role.name}
                    </td>
                    <td className="py-4 text-right">
                       <input 
                          onClick={(e) => e.stopPropagation()}
                          type="number"
                          className="w-24 bg-transparent text-right text-zinc-300 hover:bg-zinc-800 rounded px-1 outline-none focus:bg-zinc-800"
                          value={role.salary}
                          onChange={(e) => handleSalaryChange(role.id, e.target.value)}
                          onWheel={(e) => e.target.blur()}
                       />
                    </td>
                    <td className="py-4 text-right">
                       <input 
                          onClick={(e) => e.stopPropagation()}
                          type="number"
                          step="0.01"
                          className="w-16 bg-transparent text-right text-zinc-300 hover:bg-zinc-800 rounded px-1 outline-none focus:bg-zinc-800"
                          value={role.socialCostFactor}
                          onChange={(e) => handleSocialCostFactorChange(role.id, e.target.value)}
                          onWheel={(e) => e.target.blur()}
                       />
                    </td>
                    <td className="py-4 text-right font-mono text-sm text-zinc-500">
                      {formatCompactNOK(annualCostPerEmployee)}
                    </td>
                    <td className="py-4 text-right font-bold text-zinc-200">
                      {totalFTEs.toFixed(1)}
                    </td>
                    <td className="py-4 pr-4 text-right font-mono font-bold text-zinc-200">
                      {formatNOK(role.roleAnnualCost)}
                    </td>
                  </tr>
                  
                  {expandedRows[role.id] && (
                    <tr className="bg-zinc-900/50 shadow-inner">
                      <td colSpan="7" className="p-4">
                        <div className="bg-zinc-950/50 rounded-lg border border-zinc-800 p-4 animate-in slide-in-from-top-2 duration-200">
                          <div className="flex justify-between items-center mb-4">
                            <h4 className="text-[10px] uppercase text-zinc-500 font-semibold tracking-wider">
                              Bemanning per måned (Antall årsverk)
                            </h4>
                            <div className="flex gap-2">
                              <button 
                                onClick={() => handleBulkStaffChange(role.id, -1)}
                                className="flex items-center gap-1 px-3 py-1 rounded bg-zinc-800 hover:bg-zinc-700 text-xs text-zinc-300 transition-colors border border-zinc-700"
                              >
                                <Minus size={12}/> 1 Årsverk
                              </button>
                              <button 
                                onClick={() => handleBulkStaffChange(role.id, 1)}
                                className="flex items-center gap-1 px-3 py-1 rounded bg-zinc-800 hover:bg-zinc-700 text-xs text-zinc-300 transition-colors border border-zinc-700"
                              >
                                <Plus size={12}/> 1 Årsverk
                              </button>
                            </div>
                          </div>
                          <div className="grid grid-cols-6 md:grid-cols-12 gap-2">
                            {MONTHS.map((m, idx) => (
                              <div key={m} className="flex flex-col gap-1">
                                <label className="text-[9px] text-zinc-500 uppercase text-center">{m}</label>
                                <InputField 
                                  value={role.months[idx]} 
                                  onChange={(e) => handleMonthlyStaffChange(role.id, idx, e.target.value)}
                                  placeholder="0"
                                  step="0.1"
                                  className="text-center bg-zinc-900 focus:bg-zinc-800 text-xs py-1"
                                />
                              </div>
                            ))}
                          </div>
                        </div>
                      </td>
                    </tr>
                  )}
                </React.Fragment>
              )})}
            </tbody>
          </table>
        </div>
      </Card>

      {/* 2. KONSULENTER */}
      <Card>
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b border-zinc-800 gap-4">
          <h2 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
            <Briefcase className="text-zinc-400" size={20}/>
            Konsulentarbeid
          </h2>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="border-b border-zinc-800 text-zinc-500 text-xs uppercase tracking-wider">
                <th className="py-4 pl-4 w-8"></th>
                <th className="py-4 font-medium">Tjeneste</th>
                <th className="py-4 text-right font-medium">Månedspris (Rate)</th>
                <th className="py-4 text-right font-medium text-zinc-300">Totalt Antall/Mnd</th>
                <th className="py-4 pr-4 text-right font-medium text-zinc-300">Total Kostnad</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-zinc-800/50">
              {fixedCostCalculations.consultantBreakdown.map((cons) => {
                const avgQty = cons.months.reduce((a, b) => a + b, 0) / 12;

                return (
                <React.Fragment key={cons.id}>
                  <tr 
                    onClick={() => toggleRow(cons.id)}
                    className={`cursor-pointer transition-colors group ${
                      expandedRows[cons.id] ? 'bg-zinc-800/30' : 'hover:bg-zinc-800/30'
                    }`}
                  >
                    <td className="py-4 pl-4 text-zinc-600">
                       {expandedRows[cons.id] ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                    </td>
                    <td className="py-4 font-medium text-zinc-200 flex items-center gap-3">
                       <div className="w-8 h-8 bg-zinc-800 rounded flex items-center justify-center border border-zinc-700 shrink-0">
                         <Briefcase size={14} className="text-zinc-400"/>
                       </div>
                       {cons.name}
                    </td>
                    <td className="py-4 text-right">
                       <input 
                          onClick={(e) => e.stopPropagation()}
                          type="number"
                          className="w-28 bg-transparent text-right text-zinc-300 hover:bg-zinc-800 rounded px-1 outline-none focus:bg-zinc-800"
                          value={cons.monthlyRate}
                          onChange={(e) => handleConsultantRateChange(cons.id, e.target.value)}
                          onWheel={(e) => e.target.blur()}
                       />
                    </td>
                    <td className="py-4 text-right font-bold text-zinc-200">
                      {avgQty.toFixed(1)} <span className="text-xs font-normal text-zinc-500">(snitt)</span>
                    </td>
                    <td className="py-4 pr-4 text-right font-mono font-bold text-zinc-200">
                      {formatNOK(cons.consAnnualCost)}
                    </td>
                  </tr>
                  
                  {expandedRows[cons.id] && (
                    <tr className="bg-zinc-900/50 shadow-inner">
                      <td colSpan="5" className="p-4">
                        <div className="bg-zinc-950/50 rounded-lg border border-zinc-800 p-4 animate-in slide-in-from-top-2 duration-200">
                          <h4 className="text-[10px] uppercase text-zinc-500 font-semibold tracking-wider mb-2">
                            Antall / Mengde per måned
                          </h4>
                          <div className="grid grid-cols-6 md:grid-cols-12 gap-2">
                            {MONTHS.map((m, idx) => (
                              <div key={m} className="flex flex-col gap-1">
                                <label className="text-[9px] text-zinc-500 uppercase text-center">{m}</label>
                                <InputField 
                                  value={cons.months[idx]} 
                                  onChange={(e) => handleMonthlyConsultingChange(cons.id, idx, e.target.value)}
                                  placeholder="0"
                                  step="0.5"
                                  className="text-center bg-zinc-900 focus:bg-zinc-800 text-xs py-1"
                                />
                              </div>
                            ))}
                          </div>
                        </div>
                      </td>
                    </tr>
                  )}
                </React.Fragment>
              )})}
            </tbody>
          </table>
        </div>
      </Card>

      {/* 4. LÅNEKOSTNADER (SIMPLIFIED TABLE) */}
      <Card>
        <div className="flex justify-between items-center mb-6 pb-4 border-b border-zinc-800">
          <h2 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
            <Landmark className="text-zinc-400" size={20}/>
            Lånekostnader (Finans)
          </h2>
          <div className="text-right">
             <div className="text-[10px] text-zinc-500 uppercase tracking-wider font-bold">Total Renter/Gebyr/Avdrag</div>
             <div className="font-mono text-sm text-zinc-300">{formatNOK(loanCosts.totalAnnualPayment)}</div>
           </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="border-b border-zinc-800 text-zinc-500 text-xs uppercase tracking-wider">
                <th className="py-4 pl-4 w-8"></th>
                <th className="py-4 font-medium">Lån</th>
                <th className="py-4 text-right font-medium">Månedlig Kostnad (Snitt)</th>
                <th className="py-4 pr-4 text-right font-medium">Årlig Totalkostnad</th>
                <th className="py-4 w-10"></th>
              </tr>
            </thead>
            <tbody className="divide-y divide-zinc-800/50">
              {loans.map(loan => {
                const loanBreakdown = loanCosts.loansBreakdown.find(l => l.id === loan.id);
                const annualTotal = loanBreakdown ? loanBreakdown.annualTotal : 0;
                const monthlyAvg = annualTotal / 12;

                // If not active, show dimmer
                const rowClass = loan.isActive ? 'hover:bg-zinc-800/30' : 'opacity-50 hover:opacity-70';

                return (
                  <tr key={loan.id} className={`transition-colors ${rowClass}`}>
                    <td className="py-3 pl-4 text-zinc-500">
                       <div className="w-8 h-8 bg-zinc-800 rounded flex items-center justify-center border border-zinc-700 shrink-0">
                          <Landmark size={14} className="text-zinc-400"/>
                       </div>
                    </td>
                    <td className="py-3 pl-4 font-medium text-zinc-200">
                       {loan.name}
                       {!loan.isActive && <span className="ml-2 text-[10px] text-zinc-500 uppercase tracking-wider border border-zinc-700 rounded px-1">(Inaktiv)</span>}
                    </td>
                    <td className="py-3 text-right font-mono text-zinc-400">
                       {formatNOK(monthlyAvg)}
                    </td>
                    <td className="py-3 pr-4 text-right font-mono text-zinc-300">
                       {formatNOK(annualTotal)}
                    </td>
                    <td className="py-3 pr-2 text-right">
                      <button 
                        onClick={() => onEditLoan(loan)}
                        className="p-1.5 rounded-full hover:bg-zinc-700 text-zinc-500 hover:text-zinc-200 transition-colors"
                        title="Rediger lånebetingelser"
                      >
                        <Settings size={14} />
                      </button>
                    </td>
                  </tr>
                );
              })}
              {loans.length === 0 && (
                <tr><td colSpan="5" className="py-4 text-center text-zinc-500 text-sm italic">Ingen lån lagt til i Likviditet.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </Card>

      {/* 3. ANDRE DRIFTSKOSTNADER */}
      <Card>
        <div className="flex justify-between items-center mb-6 pb-4 border-b border-zinc-800">
          <h2 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
            <Building className="text-zinc-400" size={20}/>
            Andre Driftskostnader
          </h2>
           <div className="text-right">
             <div className="text-[10px] text-zinc-500 uppercase tracking-wider font-bold">Årlig Total</div>
             <div className="font-mono text-sm text-zinc-300">{formatNOK(fixedCostCalculations.otherAnnualTotal)}</div>
           </div>
        </div>

        {/* LIST LAYOUT */}
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="border-b border-zinc-800 text-zinc-500 text-xs uppercase tracking-wider">
                <th className="py-4 pl-4 w-16"></th>
                <th className="py-4 font-medium">Post</th>
                <th className="py-4 text-right font-medium">Månedlig</th>
                <th className="py-4 pr-4 text-right font-medium">Årlig</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-zinc-800/50">
               {fixedCostCalculations.otherCostsBreakdown.map(item => (
                 <tr key={item.id} className="hover:bg-zinc-800/30 transition-colors group">
                    <td className="py-3 pl-4 text-zinc-500">
                       <div className="w-8 h-8 bg-zinc-800 rounded flex items-center justify-center border border-zinc-700 shrink-0">
                          <item.icon size={14} className="text-zinc-400"/>
                       </div>
                    </td>
                    <td className="py-3 pl-4 font-medium text-zinc-200">
                       <div>{item.name}</div>
                       {item.variablePerUnit && (
                         <div className="text-[10px] text-zinc-500">+ {item.variablePerUnit} kr pr solgt enhet</div>
                       )}
                    </td>
                    <td className="py-3 text-right">
                       <div className="flex items-center justify-end gap-1">
                         <span className="text-zinc-500 text-xs mr-1">Fast:</span>
                         <input 
                           type="number"
                           className="w-20 bg-transparent text-right font-mono text-zinc-200 outline-none focus:bg-zinc-800 rounded px-2 py-1 border-b border-transparent focus:border-zinc-500 transition-all"
                           value={item.monthlyCost}
                           onChange={(e) => handleOtherCostChange(item.id, e.target.value)}
                           onWheel={(e) => e.target.blur()}
                         />
                       </div>
                    </td>
                    <td className="py-3 pr-4 text-right font-mono text-zinc-400">
                       {formatNOK(item.annualItemCost)}
                    </td>
                 </tr>
               ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
};

/* ---------------------------------------------------------------------
   LIKVIDITETSTAB
   --------------------------------------------------------------------- */

const LiquidityTab = ({ liquidityCalculations, initialLiquidity, setInitialLiquidity, loans, setLoans, equityInjections, setEquityInjections }) => {
  
  // --- LOANS ---
  const handleLoanChange = (index, field, value) => {
    const updatedLoans = [...loans];
    updatedLoans[index] = { ...updatedLoans[index], [field]: value };
    setLoans(updatedLoans);
  };

  const toggleLoanActive = (index) => {
    const updatedLoans = [...loans];
    updatedLoans[index] = { ...updatedLoans[index], isActive: !updatedLoans[index].isActive };
    setLoans(updatedLoans);
  };

  const addLoan = () => {
    setLoans([...loans, { id: `loan_${Date.now()}`, name: 'Nytt Lån', amount: 0, startMonth: 0, interestRate: 7.7, termYears: 7, gracePeriodMonths: 0, establishmentFeeRate: 0, isActive: false }]);
  };

  const removeLoan = (index) => {
    const updatedLoans = loans.filter((_, i) => i !== index);
    setLoans(updatedLoans);
  };

  // --- EQUITY ---
  const handleEquityChange = (index, field, value) => {
    const updatedEquity = [...equityInjections];
    updatedEquity[index] = { ...updatedEquity[index], [field]: value };
    setEquityInjections(updatedEquity);
  };

  const addEquity = () => {
    setEquityInjections([...equityInjections, { id: `eq_${Date.now()}`, name: 'Ny Kapital', amount: 0, month: 0, isActive: true }]);
  };
  
  const removeEquity = (index) => {
    const updatedEquity = equityInjections.filter((_, i) => i !== index);
    setEquityInjections(updatedEquity);
  };

  return (
    <div className="space-y-8">
      
      {/* Liquidity Graph */}
      <Card>
        <div className="mb-6">
           <h2 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
             <Landmark className="text-zinc-400" size={20}/>
             Likviditetsutvikling (Bankinnskudd)
           </h2>
           <p className="text-sm text-zinc-400 mt-1">
             Inkl. MVA-betalinger, feriepenger, batch-innkjøp og kapitalinnskudd.
           </p>
        </div>
        <div className="h-[300px] w-full">
          <ResponsiveContainer width="100%" height="100%">
            <ComposedChart data={liquidityCalculations.graphData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <defs>
                <linearGradient id="colorBalance" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#6366f1" stopOpacity={0.3}/>
                  <stop offset="95%" stopColor="#6366f1" stopOpacity={0}/>
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="#ffffff10" vertical={false} />
              <XAxis dataKey="name" stroke="#525252" fontSize={12} tickLine={false} axisLine={false} />
              <YAxis stroke="#525252" fontSize={12} tickFormatter={formatCompactNOK} tickLine={false} axisLine={false} />
              <RechartsTooltip 
                contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a', borderRadius: '6px' }}
                itemStyle={{ color: '#e4e4e7' }}
                formatter={(value) => formatNOK(value)}
              />
              <Legend />
              <ReferenceLine y={0} stroke="#ef4444" strokeDasharray="3 3" />
              <Area type="monotone" dataKey="Balanse" stroke="#6366f1" strokeWidth={2} fill="url(#colorBalance)" />
            </ComposedChart>
          </ResponsiveContainer>
        </div>
      </Card>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Initial Liquidity */}
        <Card className="h-fit">
          <h3 className="text-lg font-semibold mb-4 flex items-center gap-2 text-zinc-100">
            <DollarSign className="text-zinc-400" size={20}/>
            Startkapital
          </h3>
          <div className="bg-zinc-950/50 p-4 rounded-lg border border-zinc-800">
            <label className="block text-xs uppercase text-zinc-500 mb-2 font-semibold">Bankinnskudd 1. Januar 2026</label>
            <input 
              type="number"
              className="w-full bg-zinc-900 border border-zinc-700 rounded-md px-4 py-3 text-zinc-100 text-xl font-bold outline-none focus:border-zinc-500 transition-colors"
              value={initialLiquidity}
              onChange={(e) => setInitialLiquidity(parseFloat(e.target.value) || 0)}
              onWheel={(e) => e.target.blur()}
            />
          </div>
        </Card>

        {/* Equity Injection */}
        <Card className="h-fit">
           <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
              <Wallet className="text-zinc-400" size={20}/>
              Innskutt Egenkapital
            </h3>
            <button onClick={addEquity} className="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-white">
              <Plus size={20}/>
            </button>
          </div>
          
          <div className="space-y-3">
            {equityInjections.length === 0 && <div className="text-sm text-zinc-500 italic">Ingen kapitalinnskudd lagt til.</div>}
            {equityInjections.map((eq, index) => (
              <div key={eq.id} className="flex items-center gap-3 bg-zinc-950/30 p-3 rounded-lg border border-zinc-800">
                <div className="flex-1">
                  <label className="block text-[10px] text-zinc-500 uppercase mb-1">Beskrivelse</label>
                  <input 
                    type="text" 
                    className="w-full bg-transparent border-b border-zinc-800 text-zinc-200 text-sm focus:border-zinc-500 outline-none"
                    value={eq.name}
                    onChange={(e) => handleEquityChange(index, 'name', e.target.value)}
                  />
                </div>
                 <div className="w-28">
                  <label className="block text-[10px] text-zinc-500 uppercase mb-1">Beløp</label>
                  <input 
                    type="number" 
                    className="w-full bg-transparent border-b border-zinc-800 text-zinc-200 font-mono focus:border-zinc-500 outline-none"
                    value={eq.amount}
                    onChange={(e) => handleEquityChange(index, 'amount', parseFloat(e.target.value) || 0)}
                    onWheel={(e) => e.target.blur()}
                    placeholder="0"
                  />
                </div>
                <div className="w-24">
                  <label className="block text-[10px] text-zinc-500 uppercase mb-1">Måned</label>
                  <select 
                    className="w-full bg-zinc-900 text-zinc-200 text-sm rounded p-1 border border-zinc-800 outline-none"
                    value={eq.month}
                    onChange={(e) => handleEquityChange(index, 'month', parseInt(e.target.value))}
                  >
                    {MONTHS.map((m, i) => (
                      <option key={i} value={i}>{m}</option>
                    ))}
                  </select>
                </div>
                <button onClick={() => removeEquity(index)} className="text-zinc-600 hover:text-red-400 mt-4">
                  <Trash2 size={16}/>
                </button>
              </div>
            ))}
          </div>
        </Card>

        {/* Loans */}
        <Card className="lg:col-span-2">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
              <CreditCard className="text-zinc-400" size={20}/>
              Finansiering / Lån (Utbetaling)
            </h3>
            <button onClick={addLoan} className="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-white">
              <Plus size={20}/>
            </button>
          </div>
          
          <div className="space-y-3">
            {loans.length === 0 && <div className="text-sm text-zinc-500 italic">Ingen lån lagt til.</div>}
            {loans.map((loan, index) => (
              <div key={loan.id} className={`flex items-center gap-3 p-3 rounded-lg border border-zinc-800 ${loan.isActive ? 'bg-zinc-950/50' : 'bg-zinc-950/20 opacity-60'}`}>
                
                <button onClick={() => toggleLoanActive(index)} className={`shrink-0 w-10 h-5 rounded-full relative transition-colors ${loan.isActive ? 'bg-emerald-600' : 'bg-zinc-700'}`}>
                   <div className={`w-3 h-3 bg-white rounded-full absolute top-1 shadow transition-all ${loan.isActive ? 'right-1' : 'left-1'}`}/>
                </button>

                <div className="flex-1">
                  <label className="block text-[10px] text-zinc-500 uppercase mb-1">{loan.name}</label>
                  <input 
                    type="number" 
                    className="w-full bg-transparent border-b border-zinc-800 text-zinc-200 font-mono focus:border-zinc-500 outline-none"
                    value={loan.amount}
                    onChange={(e) => handleLoanChange(index, 'amount', parseFloat(e.target.value) || 0)}
                    onWheel={(e) => e.target.blur()}
                    placeholder="0"
                  />
                </div>
                <div className="w-32">
                  <label className="block text-[10px] text-zinc-500 uppercase mb-1">Utbetales i</label>
                  <select 
                    className="w-full bg-zinc-900 text-zinc-200 text-sm rounded p-1 border border-zinc-800 outline-none"
                    value={loan.startMonth}
                    onChange={(e) => handleLoanChange(index, 'startMonth', parseInt(e.target.value))}
                  >
                    {MONTHS.map((m, i) => (
                      <option key={i} value={i}>{m}</option>
                    ))}
                  </select>
                </div>
                <button onClick={() => removeLoan(index)} className="text-zinc-600 hover:text-red-400 mt-4">
                  <Trash2 size={16}/>
                </button>
              </div>
            ))}
          </div>
          <div className="mt-4 text-xs text-zinc-500">
             Lånet påvirker kun likviditet og kostnader når bryteren er <span className="text-emerald-500 font-bold">PÅ</span>.
          </div>
        </Card>
      </div>
    </div>
  );
};

/* ---------------------------------------------------------------------
   SUMMARY TABS (ANALYSE & BOARD BUDGET)
   --------------------------------------------------------------------- */

const AnalysisTab = ({ incomeCalculations, variableCostCalculations, fixedCostCalculations, liquidityCalculations, loanCalculations, pnlData }) => {
  return (
    <div className="space-y-8">
      {/* KPI Cards */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card>
           <div className="text-zinc-400 text-xs uppercase font-bold">Total Omsetning 2026</div>
           <div className="text-2xl font-bold text-zinc-100 mt-1">{formatCompactNOK(pnlData.totalRevenue)}</div>
           <div className="text-[10px] text-zinc-500">Ekskl. mva</div>
        </Card>
        <Card>
           <div className="text-zinc-400 text-xs uppercase font-bold">EBITDA (Driftsresultat)</div>
           <div className={`text-2xl font-bold mt-1 ${pnlData.totalEBITDA >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
             {formatCompactNOK(pnlData.totalEBITDA)}
           </div>
           <div className="text-[10px] text-zinc-500">Før renter og avskr.</div>
        </Card>
        <Card>
           <div className="text-zinc-400 text-xs uppercase font-bold">Resultat før skatt</div>
           <div className={`text-2xl font-bold mt-1 ${pnlData.totalEBT >= 0 ? 'text-zinc-100' : 'text-rose-400'}`}>
             {formatCompactNOK(pnlData.totalEBT)}
           </div>
           <div className="text-[10px] text-zinc-500">Etter finans</div>
        </Card>
        <Card>
           <div className="text-zinc-400 text-xs uppercase font-bold">Likviditet (Slutt 2026)</div>
           <div className={`text-2xl font-bold mt-1 ${liquidityCalculations.finalBalance >= 0 ? 'text-zinc-100' : 'text-rose-500'}`}>
             {formatCompactNOK(liquidityCalculations.finalBalance)}
           </div>
           <div className="text-[10px] text-zinc-500">Bankinnskudd 31. des</div>
        </Card>
      </div>

      {/* P&L Chart */}
      <Card>
         <h3 className="text-lg font-semibold mb-6 flex items-center gap-2 text-zinc-100">
            <Activity size={20} className="text-zinc-400"/>
            Resultatutvikling (EBITDA)
         </h3>
         <div className="h-[300px] w-full">
           <ResponsiveContainer width="100%" height="100%">
             <ComposedChart data={pnlData.data}>
               <CartesianGrid strokeDasharray="3 3" stroke="#ffffff10" vertical={false} />
               <XAxis dataKey="name" stroke="#525252" fontSize={12} tickLine={false} axisLine={false} />
               <YAxis stroke="#525252" fontSize={12} tickFormatter={formatCompactNOK} tickLine={false} axisLine={false} />
               <RechartsTooltip 
                 contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a', borderRadius: '6px' }}
                 itemStyle={{ color: '#e4e4e7' }}
                 formatter={(value) => formatNOK(value)}
               />
               <Legend />
               <Bar dataKey="Omsetning" fill="#60a5fa" radius={[2, 2, 0, 0]} />
               <Bar dataKey="Driftskostnader" stackId="a" fill="#fb7185" radius={[0, 0, 2, 2]} />
               <Line type="monotone" dataKey="EBITDA" stroke="#34d399" strokeWidth={2} dot={{r:3}} />
             </ComposedChart>
           </ResponsiveContainer>
         </div>
      </Card>
    </div>
  );
};

const BoardBudgetTab = ({ pnlData, liquidityCalculations }) => {
  
  const grossMargin = pnlData.totalRevenue > 0 
    ? ((pnlData.totalRevenue - pnlData.totalCOGS) / pnlData.totalRevenue) * 100 
    : 0;

  const downloadCSV = () => {
    const dateStr = new Date().toLocaleDateString('no-NO');
    
    // Add BOM for UTF-8 Excel compatibility
    const BOM = "\uFEFF"; 
    let csvBody = `BUDSJETT 2026 - ALPHATEK;;\r\n`;
    csvBody += `Eksportert dato:;${dateStr};\r\n\r\n`;

    // DEL 1: SAMMENDRAG
    csvBody += `SAMMENDRAG 2026;;\r\n`;
    csvBody += `Nøkkeltall;Beløp\r\n`;
    csvBody += `Omsetning;${Math.round(pnlData.totalRevenue)}\r\n`;
    csvBody += `Varekost;${Math.round(-pnlData.totalCOGS)}\r\n`;
    csvBody += `Bruttomargin;${grossMargin.toFixed(1).replace('.', ',')}%\r\n`;
    csvBody += `Driftskostnader;${Math.round(-pnlData.totalFixedOps)}\r\n`;
    csvBody += `EBITDA;${Math.round(pnlData.totalEBITDA)}\r\n`;
    csvBody += `Finans;${Math.round(-pnlData.totalFinance)}\r\n`;
    csvBody += `Resultat før skatt;${Math.round(pnlData.totalEBT)}\r\n`;
    csvBody += `Skatt (est. 22%);${Math.round(-pnlData.totalTax)}\r\n`;
    csvBody += `Årsresultat;${Math.round(pnlData.totalNetResult)}\r\n`;
    csvBody += `Likviditet 31.12;${Math.round(liquidityCalculations.finalBalance)}\r\n\r\n`;

    // DEL 2: DETALJERT MÅNED FOR MÅNED
    csvBody += `DETALJERT RESULTATBUDSJETT (MÅNED FOR MÅNED);;\r\n`;
    
    const monthsHeader = ["Jan", "Feb", "Mar", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Des"];
    csvBody += `Post;${monthsHeader.join(";")};TOTALT\r\n`;

    // Helper to generate row
    const generateRow = (label, dataKey, isNegative = false) => {
      const monthlyValues = pnlData.data.map(m => {
         const val = m[dataKey];
         return Math.round(isNegative ? -val : val);
      });
      const total = monthlyValues.reduce((a,b) => a+b, 0);
      return `${label};${monthlyValues.join(";")};${total}`;
    };

    // Add rows
    csvBody += generateRow("Salgsinntekter", "Omsetning") + "\r\n";
    csvBody += generateRow("Varekostnad (COGS)", "Varekost", true) + "\r\n";
    
    // Bruttofortjeneste row calculation manually for CSV
    const bruttoMonthly = pnlData.data.map(m => Math.round(m.Omsetning - m.Varekost));
    const bruttoTotal = bruttoMonthly.reduce((a,b) => a+b, 0);
    csvBody += `Bruttofortjeneste;${bruttoMonthly.join(";")};${bruttoTotal}\r\n`;
    
    csvBody += generateRow("Driftskostnader (Lønn/Drift)", "Driftskostnader", true) + "\r\n";
    
    // EBITDA Row
    const ebitdaMonthly = pnlData.data.map(m => Math.round(m.EBITDA));
    const ebitdaTotal = ebitdaMonthly.reduce((a,b) => a+b, 0);
    csvBody += `EBITDA;${ebitdaMonthly.join(";")};${ebitdaTotal}\r\n`;

    csvBody += generateRow("Finanskostnader", "Finans", true) + "\r\n";
    
    // EBT Row
    const ebtMonthly = pnlData.data.map(m => Math.round(m.EBT));
    const ebtTotal = ebtMonthly.reduce((a,b) => a+b, 0);
    csvBody += `Resultat før skatt;${ebtMonthly.join(";")};${ebtTotal}\r\n`;

    // Tax Row
    csvBody += generateRow("Skatt", "Skatt", true) + "\r\n";

    // Net Result Row
    const netMonthly = pnlData.data.map(m => Math.round(m.Resultat));
    const netTotal = netMonthly.reduce((a,b) => a+b, 0);
    csvBody += `Årsresultat;${netMonthly.join(";")};${netTotal}\r\n\r\n`;


    // DEL 3: LIKVIDITETSPROGNOSE
    csvBody += `LIKVIDITETSPROGNOSE (UTGÅENDE BALANSE);;\r\n`;
    csvBody += `Måned;${monthsHeader.join(";")};31.12\r\n`;
    
    const ubMonthly = liquidityCalculations.graphData.map(m => Math.round(m.Balanse));
    csvBody += `Bankinnskudd (UB);${ubMonthly.join(";")};${Math.round(liquidityCalculations.finalBalance)}\r\n`;

    const blob = new Blob([BOM + "sep=;\r\n" + csvBody], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "budsjett_alphatek_2026_detaljert.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="space-y-8 max-w-3xl mx-auto">
      <Card>
        <div className="flex justify-between items-center mb-8">
          <h2 className="text-xl font-bold text-zinc-100">Sammendrag budsjett 2026</h2>
          <button 
            onClick={downloadCSV}
            className="flex items-center gap-2 bg-emerald-700 hover:bg-emerald-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"
          >
            <FileSpreadsheet size={16}/> Last ned Excel (CSV)
          </button>
        </div>

        <div className="overflow-hidden rounded-lg border border-zinc-800">
          <table className="w-full text-sm">
             <thead className="bg-zinc-900/50 text-zinc-400 uppercase text-xs">
               <tr>
                 <th className="px-6 py-4 text-left font-semibold">Nøkkeltall</th>
                 <th className="px-6 py-4 text-right font-semibold">Beløp</th>
               </tr>
             </thead>
             <tbody className="divide-y divide-zinc-800/50 bg-zinc-900/20">
               <tr>
                 <td className="px-6 py-4 font-medium text-zinc-200">Omsetning</td>
                 <td className="px-6 py-4 text-right text-zinc-100 font-mono">{formatNOK(pnlData.totalRevenue)}</td>
               </tr>
               <tr>
                 <td className="px-6 py-4 font-medium text-zinc-400">Varekost</td>
                 <td className="px-6 py-4 text-right text-rose-400 font-mono">-{formatNOK(pnlData.totalCOGS)}</td>
               </tr>
               <tr className="bg-zinc-800/20 font-bold">
                 <td className="px-6 py-4 text-indigo-300">Bruttomargin</td>
                 <td className="px-6 py-4 text-right text-indigo-300 font-mono">{grossMargin.toFixed(1)} %</td>
               </tr>
               <tr>
                 <td className="px-6 py-4 font-medium text-zinc-400">Driftskostnader</td>
                 <td className="px-6 py-4 text-right text-rose-400 font-mono">-{formatNOK(pnlData.totalFixedOps)}</td>
               </tr>
               <tr className="bg-zinc-800/40 font-bold text-base">
                 <td className="px-6 py-4 text-emerald-400">EBITDA</td>
                 <td className={`px-6 py-4 text-right font-mono ${pnlData.totalEBITDA >= 0 ? 'text-emerald-400' : 'text-rose-500'}`}>
                   {formatNOK(pnlData.totalEBITDA)}
                 </td>
               </tr>
               <tr>
                 <td className="px-6 py-4 font-medium text-zinc-400">Finans</td>
                 <td className="px-6 py-4 text-right text-rose-400 font-mono">-{formatNOK(pnlData.totalFinance)}</td>
               </tr>
               <tr className="font-bold">
                 <td className="px-6 py-4 text-zinc-200">Resultat før skatt</td>
                 <td className="px-6 py-4 text-right text-zinc-200 font-mono">{formatNOK(pnlData.totalEBT)}</td>
               </tr>
               <tr>
                 <td className="px-6 py-4 font-medium text-zinc-400">Skatt</td>
                 <td className="px-6 py-4 text-right text-rose-400 font-mono">-{formatNOK(pnlData.totalTax)}</td>
               </tr>
               <tr className="bg-zinc-100 text-zinc-900 font-bold text-lg">
                 <td className="px-6 py-4">Årsresultat</td>
                 <td className="px-6 py-4 text-right font-mono">
                   {formatNOK(pnlData.totalNetResult)}
                 </td>
               </tr>
               <tr>
                 <td colSpan="2" className="h-8"></td>
               </tr>
               <tr className="bg-zinc-800/60 font-bold border-t border-zinc-700">
                 <td className="px-6 py-4 text-blue-400">Likviditet 31.12</td>
                 <td className={`px-6 py-4 text-right font-mono ${liquidityCalculations.finalBalance >= 0 ? 'text-blue-400' : 'text-rose-500'}`}>
                    {formatNOK(liquidityCalculations.finalBalance)}
                 </td>
               </tr>
             </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
};


/* ---------------------------------------------------------------------
   HOVEDAPPLIKASJON
   --------------------------------------------------------------------- */

export default function BudgetGenerator() {
  const [activeTab, setActiveTab] = useState('revenue');
  
  // DATA STATES
  const [products, setProducts] = useState(INITIAL_PRODUCTS);
  const [expandedRows, setExpandedRows] = useState({});
  const [salesData, setSalesData] = useState({});
  const [stockData, setStockData] = useState({}); 
  const [staffRoles, setStaffRoles] = useState(INITIAL_STAFF);
  const [staffingData, setStaffingData] = useState({ 'role_board': Array(12).fill(2) }); 
  const [consultingData, setConsultingData] = useState({ 'cons_matre': Array(12).fill(1) });
  const [consultants, setConsultants] = useState(INITIAL_CONSULTANTS);
  const [otherCosts, setOtherCosts] = useState(INITIAL_OTHER_COSTS);
  const [initialLiquidity, setInitialLiquidity] = useState(2000000); 
  const [loans, setLoans] = useState(INITIAL_LOANS);
  const [equityInjections, setEquityInjections] = useState(INITIAL_EQUITY);

  // Modal State
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isLoanModalOpen, setIsLoanModalOpen] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [editingLoan, setEditingLoan] = useState(null);

  // Derived state for product categories
  const agreementProducts = products.filter(p => p.type === 'Agreement');
  const purchaseProducts = products.filter(p => p.type === 'Purchase');
  const addonProducts = products.filter(p => p.type === 'Addon');

  // ---- EXPORT / IMPORT FUNCTIONALITY ----
  const fileInputRef = useRef(null);

  const handleExport = () => {
    const dataToExport = {
      products,
      salesData,
      stockData,
      staffRoles,
      staffingData,
      consultants,
      consultingData,
      otherCosts,
      loans,
      initialLiquidity,
      equityInjections
    };

    const jsonString = JSON.stringify(dataToExport, null, 2);
    const blob = new Blob([jsonString], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `budsjett_alphatek_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleImportClick = () => {
    fileInputRef.current.click();
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const importedData = JSON.parse(event.target.result);
        
        // Update all states with imported data
        if (importedData.products) setProducts(importedData.products);
        if (importedData.salesData) setSalesData(importedData.salesData);
        if (importedData.stockData) setStockData(importedData.stockData);
        if (importedData.staffRoles) setStaffRoles(importedData.staffRoles);
        if (importedData.staffingData) setStaffingData(importedData.staffingData);
        if (importedData.consultants) setConsultants(importedData.consultants);
        if (importedData.consultingData) setConsultingData(importedData.consultingData);
        if (importedData.otherCosts) setOtherCosts(importedData.otherCosts);
        if (importedData.loans) setLoans(importedData.loans);
        if (importedData.initialLiquidity !== undefined) setInitialLiquidity(importedData.initialLiquidity);
        if (importedData.equityInjections) setEquityInjections(importedData.equityInjections);

        alert('Budsjett lastet inn!');
      } catch (error) {
        console.error('Feil ved import:', error);
        alert('Kunne ikke lese filen. Er det en gyldig JSON-fil?');
      }
    };
    reader.readAsText(file);
    
    // Reset value so same file can be selected again if needed
    e.target.value = null;
  };


  const toggleRow = (id) => {
    setExpandedRows(prev => ({ ...prev, [id]: !prev[id] }));
  };

  const handleMonthlyChange = (productId, monthIndex, value) => {
    const newVal = parseInt(value) || 0;
    setSalesData(prev => {
      const currentMonths = prev[productId] ? [...prev[productId]] : Array(12).fill(0);
      currentMonths[monthIndex] = newVal;
      return { ...prev, [productId]: currentMonths };
    });
  };

  // CRUD Operations
  const handleEditProduct = (product) => {
    setEditingProduct(product);
    setIsModalOpen(true);
  };

  const handleEditLoan = (loan) => {
    setEditingLoan(loan);
    setIsLoanModalOpen(true);
  };

  const handleAddProduct = (type) => {
    setEditingProduct({
      id: null,
      baseId: `custom_base_${Date.now()}`,
      type: type, 
      name: '',
      priceOneOff: 0,
      priceMonthly: 0,
      cost: 0
    });
    setIsModalOpen(true);
  };

  const saveProduct = (formData) => {
    if (formData.baseId) {
      setProducts(prev => {
        const exists = prev.some(p => p.id === formData.id);
        if (exists) {
          return prev.map(p => {
             if (p.id === formData.id) return formData;
             if (p.baseId === formData.baseId) return { ...p, cost: formData.cost, name: formData.name };
             return p;
          });
        } else {
          const newProduct = { ...formData, id: formData.id || `custom_${Date.now()}` };
          return [...prev, newProduct];
        }
      });
    } else {
      if (formData.id) {
        setProducts(prev => prev.map(p => p.id === formData.id ? formData : p));
      } else {
        const newProduct = { ...formData, id: `custom_${Date.now()}` };
        setProducts(prev => [...prev, newProduct]);
      }
    }
    setIsModalOpen(false);
  };

  const saveLoanSettings = (formData) => {
    setLoans(prev => prev.map(l => l.id === formData.id ? formData : l));
    setIsLoanModalOpen(false);
  };

  const deleteProduct = (id) => {
    setProducts(prev => prev.filter(p => p.id !== id));
    setIsModalOpen(false);
  };

  // --- BEREGNINGER (LIFTED STATE) ---

  // 1. REVENUE (CASH IN)
  const incomeCalculations = useMemo(() => {
    let totalOneOff = 0;
    let totalARR = 0; 
    let budget2025CashFlow = 0;
    
    // Revenue (excl VAT)
    const monthlyRevenueExVAT = Array(12).fill(0).map(() => ({ oneOff: 0, recurring: 0, total: 0 }));
    // VAT Inflow (Output VAT)
    const monthlyVATIn = Array(12).fill(0);

    products.forEach(product => {
      const months = salesData[product.id] || Array(12).fill(0);
      const totalUnits = months.reduce((a, b) => a + b, 0);
      const rowOneOff = totalUnits * product.priceOneOff;
      const rowARR = totalUnits * product.priceMonthly * 12;

      totalOneOff += rowOneOff;
      totalARR += rowARR;

      months.forEach((unitsSold, mIndex) => {
        // One-time revenue
        const oneOffRev = unitsSold * product.priceOneOff;
        monthlyRevenueExVAT[mIndex].oneOff += oneOffRev;
        monthlyRevenueExVAT[mIndex].total += oneOffRev; // Fixed: Add to total
        monthlyVATIn[mIndex] += oneOffRev * 0.25;

        // Recurring revenue (accumulates)
        for (let i = mIndex; i < 12; i++) {
           const recRev = unitsSold * product.priceMonthly;
           monthlyRevenueExVAT[i].recurring += recRev;
           monthlyRevenueExVAT[i].total += recRev; // Fixed: Add to total
           monthlyVATIn[i] += recRev * 0.25; // Assuming recurring fee is vatable
        }
      });
    });
    
    // Total Cash Inflow from Ops (Rev + VAT)
    const monthlyCashInflow = monthlyRevenueExVAT.map((m, i) => ({
        total: m.oneOff + m.recurring + monthlyVATIn[i]
    }));

    monthlyCashInflow.forEach(m => { budget2025CashFlow += m.total; });

    const graphData = monthlyRevenueExVAT.map((m, i) => ({
      name: MONTHS[i],
      Engangs: m.oneOff,
      Gjentakende: m.recurring,
      Total: m.oneOff + m.recurring
    }));

    return { totalOneOff, totalARR, budget2025CashFlow, graphData, monthlyRevenueExVAT, monthlyVATIn, monthlyCashInflow };
  }, [salesData, products]);

  // 2. VARIABLE COSTS (CASH OUT)
  const variableCostCalculations = useMemo(() => {
    const groupedProducts = new Map();
    products.forEach(p => {
      const key = p.baseId || p.id;
      if (!groupedProducts.has(key)) {
        groupedProducts.set(key, { ...p, isGrouped: !!p.baseId, relatedIds: [] });
      }
      groupedProducts.get(key).relatedIds.push(p.id);
    });
    
    const uniqueProducts = Array.from(groupedProducts.values());
    let totalVariableCost = 0; 
    const monthlyCosts = Array(12).fill(0); 
    
    const monthlyPurchasingCashOut = Array(12).fill(0);
    const monthlyVATOut_Goods = Array(12).fill(0);

    const productBreakdown = [];

    uniqueProducts.forEach(physicalProduct => {
      const key = physicalProduct.baseId || physicalProduct.id;
      let accountingStock = stockData[key] || 0; 
      let physicalStock = stockData[key] || 0;

      const combinedSalesMonths = Array(12).fill(0);
      physicalProduct.relatedIds.forEach(relatedId => {
        const sales = salesData[relatedId] || Array(12).fill(0);
        sales.forEach((units, i) => combinedSalesMonths[i] += units);
      });
      
      let unitsProducedTotal = 0; 
      let costTotal = 0; 
      let unitsFromStockTotal = 0; 
      let totalSales = 0;

      const projectedDemand = [...combinedSalesMonths];
      projectedDemand.push(0, 0); 

      const incomingGoods = Array(14).fill(0); 

      for (let m = 0; m < 12; m++) {
          physicalStock += incomingGoods[m];
          const demandNow = projectedDemand[m];
          physicalStock -= demandNow;

          const demandNext = projectedDemand[m+1];
          const demandInTwoMonths = projectedDemand[m+2];
          
          const projectedStockBeforeM2 = physicalStock - demandNext + incomingGoods[m+1]; 
          
          if (projectedStockBeforeM2 < demandInTwoMonths) {
             const deficit = demandInTwoMonths - projectedStockBeforeM2;
             const batches = Math.ceil(deficit / 10);
             const unitsToBuy = batches * 10;
             
             const purchaseCost = unitsToBuy * physicalProduct.cost;
             
             // The order is placed in current month m
             // Cash out happens in current month m
             monthlyPurchasingCashOut[m] += purchaseCost;
             monthlyVATOut_Goods[m] += purchaseCost * 0.25;

             // Goods arrive in m+2
             // Check bounds
             if (m + 2 < 14) {
                 incomingGoods[m+2] += unitsToBuy;
             }
             unitsProducedTotal += unitsToBuy;
          }
      }
      
      // Accounting COGS logic
      let tempStock = stockData[key] || 0;
      combinedSalesMonths.forEach((unitsSold, mIndex) => {
        totalSales += unitsSold;
        let fromStock = 0;
        let produced = 0;

        if (tempStock >= unitsSold) {
          fromStock = unitsSold;
          tempStock -= unitsSold;
        } else {
          fromStock = tempStock;
          produced = unitsSold - tempStock;
          tempStock = 0;
        }
        
        const monthlyCost = safeFloat(unitsSold * physicalProduct.cost); 
        monthlyCosts[mIndex] += monthlyCost;

        unitsFromStockTotal += fromStock;
        costTotal += monthlyCost;
      });

      totalVariableCost += costTotal;
      productBreakdown.push({
        ...physicalProduct,
        stockKey: key,
        totalSales,
        unitsFromStockTotal,
        unitsProducedTotal, 
        costTotal
      });
    });

    const graphData = MONTHS.map((m, i) => ({ name: m, Kostnad: monthlyPurchasingCashOut[i] }));
    return { totalVariableCost, productBreakdown, graphData, monthlyCosts, monthlyPurchasingCashOut, monthlyVATOut_Goods };
  }, [products, salesData, stockData]);

  // 3. LOAN COSTS
  const loanCalculations = useMemo(() => {
    const monthlyTotalCashOut = Array(12).fill(0); 
    const monthlyInterestAndFees = Array(12).fill(0); 
    const monthlyPrincipal = Array(12).fill(0); 

    const loansBreakdown = loans.map(loan => {
        if (!loan.isActive) return { ...loan, annualTotal: 0, annualInterest: 0 };

        const payoutMonth = loan.startMonth;
        let loanTotalCost = 0;
        let loanInterestCost = 0;
        let remainingBalance = loan.amount;
        
        for(let i = 0; i < 12; i++) {
            if (i < payoutMonth) continue; 

            if (i === payoutMonth) {
                const fee = safeFloat(loan.amount * (loan.establishmentFeeRate / 100));
                monthlyTotalCashOut[i] += fee;
                monthlyInterestAndFees[i] += fee;
                loanTotalCost += fee;
                loanInterestCost += fee;
            }

            const monthlyInterest = safeFloat(remainingBalance * (loan.interestRate / 100 / 12));
            monthlyTotalCashOut[i] += monthlyInterest;
            monthlyInterestAndFees[i] += monthlyInterest;
            loanTotalCost += monthlyInterest;
            loanInterestCost += monthlyInterest;

            const monthsSinceStart = i - payoutMonth;
            if (monthsSinceStart >= loan.gracePeriodMonths) {
                const principalPayment = safeFloat(loan.amount / (loan.termYears * 12));
                monthlyTotalCashOut[i] += principalPayment;
                monthlyPrincipal[i] += principalPayment;
                loanTotalCost += principalPayment;
                remainingBalance -= principalPayment;
            }
        }
        return { ...loan, annualTotal: loanTotalCost, annualInterest: loanInterestCost };
    });

    const totalAnnualPayment = loansBreakdown.reduce((acc, l) => acc + l.annualTotal, 0);
    return { monthlyTotalCashOut, monthlyInterestAndFees, monthlyPrincipal, totalAnnualPayment, loansBreakdown };
  }, [loans]);


  // 4. FIXED COSTS (CASH OUT)
  const fixedCostCalculations = useMemo(() => {
    let totalFixedCost = 0;
    const monthlyCosts = Array(12).fill(0); 
    const monthlyVATOut_Ops = Array(12).fill(0); 

    const roleBreakdown = staffRoles.map(role => {
      const months = staffingData[role.id] || Array(12).fill(0);
      let roleAnnualCost = 0;
      const currentFactor = role.socialCostFactor || 1.4;
      
      months.forEach((ftes, idx) => {
        let cost = 0;
        if (idx === 5) { 
            cost = safeFloat(((role.salary * currentFactor) / 12) * ftes * 1.5);
        } else {
            cost = safeFloat(((role.salary * currentFactor) / 12) * ftes);
        }
        monthlyCosts[idx] += cost;
        roleAnnualCost += cost;
      });
      totalFixedCost += roleAnnualCost;
      return { ...role, months, roleAnnualCost };
    });

    const consultantBreakdown = consultants.map(cons => {
      const months = consultingData[cons.id] || Array(12).fill(0);
      let consAnnualCost = 0;
      months.forEach((qty, idx) => {
        const cost = safeFloat(cons.monthlyRate * qty);
        monthlyCosts[idx] += cost * 1.25; 
        monthlyVATOut_Ops[idx] += cost * 0.25; 
        consAnnualCost += cost; 
      });
      totalFixedCost += consAnnualCost;
      return { ...cons, months, consAnnualCost };
    });

    let otherAnnualTotal = 0;
    const accumulatedUnits = Array(12).fill(0);
    let runningTotal = 0;
    const monthlySalesTotal = Array(12).fill(0);
    products.forEach(p => {
        if (p.type !== 'Addon') {
            const sales = salesData[p.id] || Array(12).fill(0);
            sales.forEach((qty, idx) => monthlySalesTotal[idx] += qty);
        }
    });
    for(let i=0; i<12; i++) {
        runningTotal += monthlySalesTotal[i];
        accumulatedUnits[i] = runningTotal;
    }

    const otherCostsBreakdown = otherCosts.map(costItem => {
        let annualItemCost = 0;
        for (let i = 0; i < 12; i++) {
            let monthly = costItem.monthlyCost;
            if (costItem.variablePerUnit) {
                monthly += safeFloat(accumulatedUnits[i] * costItem.variablePerUnit);
            }
            
            const isVatable = !['cost_insurance', 'cost_loan'].includes(costItem.id);
            
            if (isVatable) {
                monthlyCosts[i] += monthly * 1.25;
                monthlyVATOut_Ops[i] += monthly * 0.25;
            } else {
                monthlyCosts[i] += monthly;
            }
            
            annualItemCost += monthly;
        }
        otherAnnualTotal += annualItemCost;
        return { ...costItem, annualItemCost };
    });
    
    for(let i=0; i<12; i++) {
        monthlyCosts[i] += loanCalculations.monthlyTotalCashOut[i];
    }
    
    totalFixedCost += otherAnnualTotal + loanCalculations.totalAnnualPayment;
    const graphData = MONTHS.map((m, i) => ({ name: m, Kostnad: monthlyCosts[i] }));

    return { totalFixedCost, roleBreakdown, consultantBreakdown, otherAnnualTotal, otherCostsBreakdown, graphData, monthlyCosts, monthlyVATOut_Ops };
  }, [staffRoles, staffingData, consultants, consultingData, otherCosts, salesData, products, loanCalculations]);

  // 5. LIQUIDITY CALCULATIONS
  const liquidityCalculations = useMemo(() => {
    let currentBalance = initialLiquidity;
    const monthlyBalances = [];
    
    const vatPayments = Array(12).fill(0);
    const accumulatedVATLiability = Array(12).fill(0);
    let currentTermNetVAT = 0;

    for (let i = 0; i < 12; i++) {
        const vatIn = incomeCalculations.monthlyVATIn[i];
        const vatOut = variableCostCalculations.monthlyVATOut_Goods[i] + fixedCostCalculations.monthlyVATOut_Ops[i];
        const netVAT = vatIn - vatOut; 
        
        currentTermNetVAT += netVAT;
        accumulatedVATLiability[i] = currentTermNetVAT;

        if ((i + 1) % 2 === 0) {
             const paymentMonth = i + 2;
             if (paymentMonth < 12) {
                 vatPayments[paymentMonth] = currentTermNetVAT;
             }
             currentTermNetVAT = 0; 
        }
    }

    for (let i = 0; i < 12; i++) {
      const income = incomeCalculations.monthlyCashInflow[i].total; // Incl VAT
      const varCost = variableCostCalculations.monthlyPurchasingCashOut[i] * 1.25; // Incl VAT
      const fixCost = fixedCostCalculations.monthlyCosts[i]; 
      const vatPay = vatPayments[i]; 
      
      let monthlyLoanPayout = 0;
      loans.forEach(loan => {
        if (loan.isActive && loan.startMonth === i) monthlyLoanPayout += loan.amount;
      });

      let monthlyEquity = 0;
      equityInjections.forEach(eq => {
        if (eq.isActive && eq.month === i) monthlyEquity += eq.amount;
      });

      const totalOut = varCost + fixCost + vatPay;
      const totalIn = income + monthlyLoanPayout + monthlyEquity;
      
      const netChange = totalIn - totalOut;
      currentBalance += netChange;
      
      monthlyBalances.push({
        name: MONTHS[i],
        Balanse: currentBalance,
        Inn: totalIn,
        Ut: totalOut,
        MvaBetaling: vatPay
      });
    }

    return { graphData: monthlyBalances, finalBalance: currentBalance };
  }, [initialLiquidity, loans, equityInjections, incomeCalculations, variableCostCalculations, fixedCostCalculations]);

  // P&L Data Calc (Shared for Summary & Board)
  const pnlData = useMemo(() => {
    const data = [];
    let totalRevenue = 0;
    let totalCOGS = 0;
    let totalFixedOps = 0; 
    let totalFinance = 0; 
    let totalEBITDA = 0;
    let totalEBT = 0;
    let totalTax = 0;
    let totalNetResult = 0;

    for(let i=0; i<12; i++) {
       const rev = incomeCalculations.monthlyRevenueExVAT[i].total;
       const cogs = variableCostCalculations.monthlyCosts[i];
       
       const opsCashOutWithVAT = fixedCostCalculations.monthlyCosts[i] - loanCalculations.monthlyTotalCashOut[i]; 
       const opsVAT = fixedCostCalculations.monthlyVATOut_Ops[i];
       const fixedOpsNet = opsCashOutWithVAT - opsVAT;
       
       const finance = loanCalculations.monthlyInterestAndFees[i];

       const ebitda = rev - cogs - fixedOpsNet;
       const ebt = ebitda - finance;
       
       const tax = ebt > 0 ? ebt * 0.22 : 0;
       const netResult = ebt - tax;

       data.push({
         name: MONTHS[i],
         Omsetning: rev,
         Varekost: cogs,
         Dekningsbidrag: rev - cogs,
         Driftskostnader: fixedOpsNet,
         EBITDA: ebitda,
         Finans: finance,
         EBT: ebt,
         Skatt: tax,
         Resultat: netResult
       });

       totalRevenue += rev;
       totalCOGS += cogs;
       totalFixedOps += fixedOpsNet;
       totalEBITDA += ebitda;
       totalFinance += finance;
       totalEBT += ebt;
       totalTax += tax;
       totalNetResult += netResult;
    }

    return { data, totalRevenue, totalCOGS, totalFixedOps, totalEBITDA, totalFinance, totalEBT, totalTax, totalNetResult };
  }, [incomeCalculations, variableCostCalculations, fixedCostCalculations, loanCalculations]);


  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-200 font-sans selection:bg-zinc-700/50">
      
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute top-0 left-0 right-0 h-[500px] bg-gradient-to-b from-zinc-900/50 via-zinc-950/80 to-zinc-950" />
      </div>

      <div className="relative z-10 max-w-7xl mx-auto px-6 py-10">
        
        <header className="mb-12">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-4xl font-bold tracking-tight text-zinc-100">
                Budsjett 2026
              </h1>
              <img src="https://storage.googleapis.com/files_webpage/Logo/.PNG/Copy%20of%20Logo%20narrow.png" alt="Alphatek Logo" className="h-6 mt-2" />
            </div>
            <div className="flex gap-3">
               <input 
                  type="file" 
                  ref={fileInputRef} 
                  onChange={handleFileChange} 
                  accept=".json,.txt" 
                  className="hidden" 
               />
               
               <button 
                 onClick={handleImportClick}
                 className="p-3 rounded-full bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 transition flex items-center gap-2 text-zinc-400 hover:text-zinc-200"
                 title="Last opp budsjettfil"
               >
                 <Upload size={20} />
               </button>

               <button 
                 onClick={handleExport}
                 className="p-3 rounded-full bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 transition flex items-center gap-2 text-zinc-400 hover:text-zinc-200"
                 title="Last ned budsjettfil"
               >
                 <Download size={20} />
               </button>
            </div>
          </div>

          <nav className="flex flex-wrap gap-2 mt-8 border-b border-zinc-800 pb-4">
            <TabButton active={activeTab === 'revenue'} onClick={() => setActiveTab('revenue')} icon={DollarSign} label="1. Inntekter" />
            <TabButton active={activeTab === 'variable'} onClick={() => setActiveTab('variable')} icon={Package} label="2. Variable Kostnader" />
            <TabButton active={activeTab === 'fixed'} onClick={() => setActiveTab('fixed')} icon={Settings} label="3. Faste Kostnader" />
            <TabButton active={activeTab === 'liquidity'} onClick={() => setActiveTab('liquidity')} icon={Landmark} label="4. Likviditet" />
            <TabButton active={activeTab === 'board'} onClick={() => setActiveTab('board')} icon={FileSpreadsheet} label="5. Budsjett" />
            <TabButton active={activeTab === 'summary'} onClick={() => setActiveTab('summary')} icon={PieIcon} label="6. Analyse" />
          </nav>
        </header>

        <main className="animate-in fade-in slide-in-from-bottom-4 duration-500">
          
          {activeTab === 'revenue' && (
            <div className="space-y-8">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <Card>
                  <h3 className="text-zinc-400 text-xs uppercase tracking-wider font-bold">Totalt Cash Flow 2026</h3>
                  <div className="text-3xl font-bold mt-2 text-zinc-100">{formatNOK(incomeCalculations.budget2025CashFlow)}</div>
                  <div className="text-xs text-zinc-500 mt-1">Inkl. MVA (Cash Inn)</div>
                </Card>
                <Card>
                  <h3 className="text-zinc-400 text-xs uppercase tracking-wider font-bold">Ny Signert ARR</h3>
                  <div className="text-3xl font-bold mt-2 text-zinc-100">{formatNOK(incomeCalculations.totalARR)}</div>
                  <div className="text-xs text-zinc-500 mt-1">Årsverdi av nye lisenser</div>
                </Card>
                 <Card>
                  <h3 className="text-zinc-400 text-xs uppercase tracking-wider font-bold">Total Kontraktsverdi</h3>
                  <div className="text-3xl font-bold mt-2 text-zinc-100">{formatNOK(incomeCalculations.totalOneOff + incomeCalculations.totalARR)}</div>
                  <div className="text-xs text-zinc-500 mt-1">Engangs + 12 mnd lisensverdi</div>
                </Card>
              </div>

              <Card>
                <div className="mb-6">
                   <h2 className="text-lg font-semibold flex items-center gap-2 text-zinc-100">
                     <TrendingUp className="text-zinc-400" size={20}/>
                     Inntektsutvikling 2026 (Omsetning)
                   </h2>
                   <p className="text-sm text-zinc-500 mt-1">
                     Viser omsetning ekskl. MVA.
                   </p>
                </div>
                <div className="h-[300px] w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <ComposedChart data={incomeCalculations.graphData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                      <defs>
                        <linearGradient id="colorEngangs" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#fcd34d" stopOpacity={0.3}/>
                          <stop offset="95%" stopColor="#fcd34d" stopOpacity={0}/>
                        </linearGradient>
                        <linearGradient id="colorGjentakende" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#2dd4bf" stopOpacity={0.3}/>
                          <stop offset="95%" stopColor="#2dd4bf" stopOpacity={0}/>
                        </linearGradient>
                      </defs>
                      <CartesianGrid strokeDasharray="3 3" stroke="#ffffff05" vertical={false} />
                      <XAxis dataKey="name" stroke="#525252" fontSize={12} tickLine={false} axisLine={false} />
                      <YAxis stroke="#525252" fontSize={12} tickFormatter={formatCompactNOK} tickLine={false} axisLine={false} />
                      <RechartsTooltip 
                        contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a', borderRadius: '6px' }}
                        itemStyle={{ color: '#e4e4e7' }}
                        formatter={(value) => formatNOK(value)}
                      />
                      <Legend />
                      <Bar dataKey="Engangs" fill="url(#colorEngangs)" radius={[4, 4, 0, 0]} stackId="a" />
                      <Area type="monotone" dataKey="Gjentakende" stroke="#2dd4bf" fill="url(#colorGjentakende)" stackId="a" />
                    </ComposedChart>
                  </ResponsiveContainer>
                </div>
              </Card>

              <div className="space-y-8">
                <ProductTable 
                  title="Abonnementssalg" 
                  icon={CreditCard}
                  products={agreementProducts} 
                  expandedRows={expandedRows} 
                  toggleRow={toggleRow} 
                  salesData={salesData} 
                  handleMonthlyChange={handleMonthlyChange}
                  headerColor="text-zinc-100"
                  onEdit={handleEditProduct}
                  onAdd={handleAddProduct}
                  type="Agreement"
                />

                <ProductTable 
                  title="Direktekjøp (Maskinvare)" 
                  icon={ShoppingCart}
                  products={purchaseProducts} 
                  expandedRows={expandedRows} 
                  toggleRow={toggleRow} 
                  salesData={salesData} 
                  handleMonthlyChange={handleMonthlyChange}
                  headerColor="text-zinc-100"
                  onEdit={handleEditProduct}
                  onAdd={handleAddProduct}
                  type="Purchase"
                />

                 <ProductTable 
                  title="Tilleggsutstyr" 
                  icon={Package}
                  products={addonProducts} 
                  expandedRows={expandedRows} 
                  toggleRow={toggleRow} 
                  salesData={salesData} 
                  handleMonthlyChange={handleMonthlyChange}
                  headerColor="text-zinc-100"
                  onEdit={handleEditProduct}
                  onAdd={handleAddProduct}
                  type="Addon"
                />
              </div>
            </div>
          )}

          {activeTab === 'variable' && (
            <VariableCostsTab 
              costCalculation={variableCostCalculations}
              stockData={stockData}
              setStockData={setStockData}
              onUpdateCost={handleEditProduct} 
            />
          )}
          
          {activeTab === 'fixed' && (
            <FixedCostsTab 
              staffRoles={staffRoles}
              setStaffRoles={setStaffRoles}
              staffingData={staffingData}
              setStaffingData={setStaffingData}
              consultants={consultants}
              setConsultants={setConsultants}
              consultingData={consultingData}
              setConsultingData={setConsultingData}
              otherCosts={otherCosts}
              setOtherCosts={setOtherCosts}
              salesData={salesData}
              products={products}
              loans={loans}
              setLoans={setLoans}
              loanCosts={loanCalculations}
              fixedCostCalculations={fixedCostCalculations}
              onEditLoan={handleEditLoan}
            />
          )}

          {activeTab === 'liquidity' && (
            <LiquidityTab 
              liquidityCalculations={liquidityCalculations}
              initialLiquidity={initialLiquidity}
              setInitialLiquidity={setInitialLiquidity}
              loans={loans}
              setLoans={setLoans}
              equityInjections={equityInjections}
              setEquityInjections={setEquityInjections}
            />
          )}

          {activeTab === 'board' && (
            <BoardBudgetTab 
              pnlData={pnlData}
              liquidityCalculations={liquidityCalculations}
            />
          )}

          {activeTab === 'summary' && (
            <AnalysisTab 
               incomeCalculations={incomeCalculations}
               variableCostCalculations={variableCostCalculations}
               fixedCostCalculations={fixedCostCalculations}
               liquidityCalculations={liquidityCalculations}
               loanCalculations={loanCalculations}
               pnlData={pnlData}
            />
          )}

          <EditProductModal 
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            product={editingProduct}
            onSave={saveProduct}
            onDelete={deleteProduct}
          />

          <LoanSettingsModal 
            isOpen={isLoanModalOpen}
            onClose={() => setIsLoanModalOpen(false)}
            loan={editingLoan}
            onSave={saveLoanSettings}
          />

        </main>
      </div>
    </div>
  );
}
