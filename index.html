import React, { useState, useMemo, useEffect } from 'react';
import { 
  BarChart, Bar, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, 
  ComposedChart, Line, ReferenceLine, Cell 
} from 'recharts';
import { 
  Calculator, Users, Package, TrendingUp, Landmark, FileSpreadsheet, Save, Upload, 
  Activity, AlertTriangle, ArrowRight, Settings, DollarSign, Box, Briefcase, X, Plus, Trash2, UserPlus, CreditCard, Wallet, Info, PieChart, BookOpen, CheckSquare 
} from 'lucide-react';

// --- Constants & Configuration ---

const MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// Initial Data Loading
const RAW_PRODUCTS = [
    { id: 'p1', name: 'AlphaPWR Small', type: 'agreement', baseId: 'sys_small', price: 18250, sub: 3200, cost: 25000, img: 'https://storage.googleapis.com/files_webpage/Small%20Transparent.png' },
    { id: 'p2', name: 'AlphaPWR Medium', type: 'agreement', baseId: 'sys_medium', price: 22500, sub: 3890, cost: 44000, img: 'https://storage.googleapis.com/files_webpage/Medium%20Transparent.png' },
    { id: 'p3', name: 'AlphaPWR Double', type: 'agreement', baseId: 'sys_double', price: 42500, sub: 7000, cost: 87000, img: 'https://storage.googleapis.com/files_webpage/Large%20Transparent.png' },
    { id: 'p4', name: 'AlphaPWR Small', type: 'purchase', baseId: 'sys_small', price: 140000, sub: 950, cost: 25000, img: 'https://storage.googleapis.com/files_webpage/Small%20Transparent.png' },
    { id: 'p5', name: 'AlphaPWR Medium', type: 'purchase', baseId: 'sys_medium', price: 170000, sub: 950, cost: 44000, img: 'https://storage.googleapis.com/files_webpage/Medium%20Transparent.png' },
    { id: 'p6', name: 'AlphaPWR Double', type: 'purchase', baseId: 'sys_double', price: 320000, sub: 950, cost: 87000, img: 'https://storage.googleapis.com/files_webpage/Large%20Transparent.png' },
    { id: 'p7', name: 'Nordic Hamstring', type: 'addon', baseId: 'addon_nordic', price: 20000, sub: 250, cost: 10000, img: 'https://storage.googleapis.com/files_webpage/Nordic%20Hamstring%205.png' },
    { id: 'p8', name: 'Pull handles', type: 'addon', baseId: 'addon_pull', price: 2450, sub: 0, cost: 2000, img: 'https://storage.googleapis.com/files_webpage/Pull.png' },
];

const RAW_INVENTORY = [
    { id: 'sys_small', name: 'AlphaPWR Small Unit', cost: 25000, initialStock: 0 },
    { id: 'sys_medium', name: 'AlphaPWR Medium Unit', cost: 44000, initialStock: 0 },
    { id: 'sys_double', name: 'AlphaPWR Double Unit', cost: 87000, initialStock: 0 },
    { id: 'addon_nordic', name: 'Nordic Hamstring', cost: 10000, initialStock: 0 },
    { id: 'addon_pull', name: 'Pull handles', cost: 2000, initialStock: 0 },
];

const ROLES_DEF = [
    { id: 'r1', name: 'Sales', salary: 750000, social: 1.4, defaultCount: Array(12).fill(0) },
    { id: 'r2', name: 'R&D', salary: 850000, social: 1.4, defaultCount: Array(12).fill(0) },
    { id: 'r3', name: 'Support', salary: 700000, social: 1.4, defaultCount: Array(12).fill(0) },
    { id: 'r4', name: 'Management', salary: 800000, social: 1.4, defaultCount: Array(12).fill(0) },
    { id: 'r5', name: 'Marketing', salary: 750000, social: 1.4, defaultCount: Array(12).fill(0) },
    { id: 'r6', name: 'Logistics', salary: 850000, social: 1.4, defaultCount: Array(12).fill(0) },
    { id: 'r7', name: 'Board Member', salary: 50000, social: 1.3, defaultCount: Array(12).fill(0) },
];

// Updated Consultant Data Structure (Direct monthly costs)
const INITIAL_CONSULTANTS = [
    { id: 'c1', name: 'Matre Consulting', costs: Array(12).fill(0) }
];

const INITIAL_OTHER_COSTS = [
    { id: 'oc1', name: 'Office Rent', monthly: 7500, vat: true },
    { id: 'oc2', name: 'Electricity', monthly: 2500, vat: true },
    { id: 'oc3', name: 'Software Subs', monthly: 2000, vat: true },
    { id: 'oc4', name: 'Accounting', monthly: 7000, vat: true },
    { id: 'oc5', name: 'Audit', monthly: 1250, vat: true },
    { id: 'oc6', name: 'Marketing Ads', monthly: 12500, vat: true },
    { id: 'oc7', name: 'Car Lease', monthly: 5833, vat: true },
    { id: 'oc8', name: 'R&D Materials', monthly: 5000, vat: true },
    { id: 'oc9', name: 'Patent Costs', monthly: 3500, vat: true },
    { id: 'oc10', name: 'Courses', monthly: 1200, vat: true },
    { id: 'oc11', name: 'Travel', monthly: 15000, vat: true },
    { id: 'oc12', name: 'Other', monthly: 5000, vat: true },
    { id: 'oc13', name: 'Insurance', monthly: 3000, vat: false },
];

const INITIAL_LOANS = [
    { id: 'l1', name: 'Innovation Norway Loan', amount: 2000000, interestRate: 7.7, termYears: 7, gracePeriod: 0, feeRate: 0.5, startMonth: 0, active: true }
];

const INITIAL_EQUITY = [
    //{ id: 'eq1', name: 'Seed Round', amount: 500000, month: 0 }
];

// --- Helpers ---

const formatNOK = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'NOK', maximumFractionDigits: 0 }).format(val).replace('NOK', 'kr');
const formatNum = (val) => new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(val);
const formatCompactNOK = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'NOK', notation: "compact", compactDisplay: "short", maximumFractionDigits: 1 }).format(val).replace('NOK', 'kr');
const safeFloat = (val) => parseFloat(val.toFixed(2));
const safeInput = (e) => e.target.blur();

// --- Main Component ---

export default function AlphatekBudget() {
    // --- State ---
    const [activeTab, setActiveTab] = useState('intro');
    
    // Core Data Models
    const [products, setProducts] = useState(RAW_PRODUCTS);
    const [inventoryItems, setInventoryItems] = useState(RAW_INVENTORY);
    
    // Inputs
    const [salesInput, setSalesInput] = useState({});
    const [startCapital, setStartCapital] = useState(0); 
    const [equityInjections, setEquityInjections] = useState(INITIAL_EQUITY);
    const [loans, setLoans] = useState(INITIAL_LOANS);
    // Fix: Initialize staff correctly with 'count' property immediately to prevent initial render crash
    const [staff, setStaff] = useState(() => ROLES_DEF.map(r => ({...r, count: [...r.defaultCount]})));
    const [consultants, setConsultants] = useState(INITIAL_CONSULTANTS); 
    const [otherCosts, setOtherCosts] = useState(INITIAL_OTHER_COSTS);
    
    // Config
    const [isStartupYear, setIsStartupYear] = useState(true); // NEW: Toggle for Holiday pay logic

    // UI State for Analysis Tab
    const [selectedInventoryItem, setSelectedInventoryItem] = useState(null);

    // UI State
    const [editingProduct, setEditingProduct] = useState(null); 
    const [editingConsultant, setEditingConsultant] = useState(null);
    const [editingRole, setEditingRole] = useState(null);
    const [editingOpCost, setEditingOpCost] = useState(null);
    const [editingLoan, setEditingLoan] = useState(null);
    const [editingEquity, setEditingEquity] = useState(null);

    // Initialization (Sales)
    useEffect(() => {
        const initSales = {};
        RAW_PRODUCTS.forEach(p => {
            initSales[p.id] = Array(12).fill(0);
        });
        setSalesInput(prev => ({...initSales, ...prev}));
        
        if (RAW_INVENTORY.length > 0) {
            setSelectedInventoryItem(RAW_INVENTORY[0].id);
        }
    }, []);

    // --- Handlers ---

    const handleSalesChange = (prodId, monthIdx, val) => {
        const newVal = parseInt(val) || 0;
        setSalesInput(prev => ({
            ...prev,
            [prodId]: prev[prodId] ? prev[prodId].map((v, i) => i === monthIdx ? newVal : v) : Array(12).fill(0).map((v,i) => i === monthIdx ? newVal : 0)
        }));
    };

    // Staff Handlers
    const handleStaffCountChange = (roleId, monthIdx, val) => {
        const newVal = parseInt(val) || 0;
        setStaff(prev => prev.map(r => {
            if (r.id !== roleId) return r;
            const newCounts = [...r.count];
            newCounts[monthIdx] = newVal;
            return { ...r, count: newCounts };
        }));
    };

    const handleRoleUpdate = (updatedRole) => {
        setStaff(prev => prev.map(r => r.id === updatedRole.id ? updatedRole : r));
        setEditingRole(null);
    };

    const handleAddRole = () => {
        const newRole = {
            id: `role_${Date.now()}`,
            name: 'New Role',
            salary: 600000,
            social: 1.4,
            count: Array(12).fill(0)
        };
        setStaff(prev => [...prev, newRole]);
        setEditingRole(newRole);
    };

    const handleDeleteRole = (id) => {
        setStaff(prev => prev.filter(r => r.id !== id));
        setEditingRole(null);
    };

    // Consultant Handlers
    const handleConsultantCostChange = (consId, monthIdx, val) => {
        const newVal = parseFloat(val) || 0;
        setConsultants(prev => prev.map(c => {
            if (c.id !== consId) return c;
            const newCosts = [...c.costs];
            newCosts[monthIdx] = newVal;
            return { ...c, costs: newCosts };
        }));
    };

    const handleAddConsultant = () => {
        const newC = {
            id: `cons_${Date.now()}`,
            name: 'New Consultant',
            costs: Array(12).fill(0)
        };
        setConsultants(prev => [...prev, newC]);
        setEditingConsultant(newC);
    };

    const handleConsultantUpdate = (updatedCons) => {
        setConsultants(prev => prev.map(c => c.id === updatedCons.id ? updatedCons : c));
        setEditingConsultant(null);
    };

    const handleDeleteConsultant = (id) => {
        setConsultants(prev => prev.filter(c => c.id !== id));
        setEditingConsultant(null);
    };

    // Operational Costs Handlers
    const handleAddOpCost = () => {
        const newOp = {
            id: `op_${Date.now()}`,
            name: 'New Cost',
            monthly: 1000,
            vat: true
        };
        setOtherCosts(prev => [...prev, newOp]);
        setEditingOpCost(newOp);
    };

    const handleOpCostUpdate = (updatedOp) => {
        setOtherCosts(prev => prev.map(op => op.id === updatedOp.id ? updatedOp : op));
        setEditingOpCost(null);
    };

    const handleDeleteOpCost = (id) => {
        setOtherCosts(prev => prev.filter(op => op.id !== id));
        setEditingOpCost(null);
    };

    // Loan Handlers
    const handleAddLoan = () => {
        const newL = {
            id: `loan_${Date.now()}`,
            name: 'New Loan',
            amount: 1000000,
            interestRate: 5.0,
            termYears: 5,
            gracePeriod: 0,
            feeRate: 0,
            startMonth: 0,
            active: true
        };
        setLoans(prev => [...prev, newL]);
        setEditingLoan(newL);
    };

    const handleLoanUpdate = (updatedLoan) => {
        setLoans(prev => prev.map(l => l.id === updatedLoan.id ? updatedLoan : l));
        setEditingLoan(null);
    };

    const handleDeleteLoan = (id) => {
        setLoans(prev => prev.filter(l => l.id !== id));
        setEditingLoan(null);
    };

    // Equity Handlers
    const handleAddEquity = () => {
        const newE = {
            id: `eq_${Date.now()}`,
            name: 'Equity Injection',
            amount: 500000,
            month: 0
        };
        setEquityInjections(prev => [...prev, newE]);
        setEditingEquity(newE);
    };

    const handleEquityUpdate = (updatedEq) => {
        setEquityInjections(prev => prev.map(e => e.id === updatedEq.id ? updatedEq : e));
        setEditingEquity(null);
    };

    const handleDeleteEquity = (id) => {
        setEquityInjections(prev => prev.filter(e => e.id !== id));
        setEditingEquity(null);
    };

    // Product CRUD
    const handleAddProduct = (type) => {
        const newId = `custom_${Date.now()}`;
        const newBaseId = `inv_${Date.now()}`; 
        
        const newProduct = {
            id: newId,
            name: 'New Product',
            type: type,
            baseId: newBaseId, 
            price: 0,
            sub: 0,
            cost: 0,
            img: '' 
        };

        const newInventoryItem = {
            id: newBaseId,
            name: 'New Product Unit',
            cost: 0,
            initialStock: 0
        };

        setProducts(prev => [...prev, newProduct]);
        setInventoryItems(prev => [...prev, newInventoryItem]);
        setSalesInput(prev => ({...prev, [newId]: Array(12).fill(0)}));
        setEditingProduct(newProduct); 
    };

    const handleDeleteProduct = (id) => {
        const prod = products.find(p => p.id === id);
        setProducts(prev => prev.filter(p => p.id !== id));
        if(prod) {
             const othersUsingBase = products.filter(p => p.baseId === prod.baseId && p.id !== id);
             if(othersUsingBase.length === 0) {
                 setInventoryItems(prev => prev.filter(i => i.id !== prod.baseId));
             }
        }
        setEditingProduct(null);
    };

    const handleProductUpdate = (updatedProduct) => {
        setProducts(prev => prev.map(p => p.id === updatedProduct.id ? updatedProduct : p));
        if (updatedProduct.baseId) {
            setInventoryItems(prev => prev.map(item => {
                if (item.id === updatedProduct.baseId) {
                    return { ...item, cost: updatedProduct.cost, name: updatedProduct.name + ' Unit' };
                }
                return item;
            }));
            setProducts(prev => prev.map(p => {
                if (p.baseId === updatedProduct.baseId && p.id !== updatedProduct.id) {
                    return { ...p, cost: updatedProduct.cost };
                }
                return p;
            }));
        }
        setEditingProduct(null);
    };

    const handleStockChange = (itemId, val) => {
        const newStock = parseInt(val) || 0;
        setInventoryItems(prev => prev.map(item => 
            item.id === itemId ? { ...item, initialStock: newStock } : item
        ));
    };

    const handleEquityChange = (idx, val) => {
        const newVal = parseFloat(val) || 0;
        setEquity(prev => prev.map((v, i) => i === idx ? newVal : v));
    };

    // Export/Import
    const handleExport = () => {
        const data = { salesInput, staff, startCapital, equityInjections, loans, products, inventoryItems, consultants, otherCosts };
        const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `alphatek_budget_2026.json`;
        a.click();
    };

    const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const data = JSON.parse(evt.target.result);
                if (data.salesInput) setSalesInput(data.salesInput);
                if (data.staff) setStaff(data.staff);
                if (data.startCapital) setStartCapital(data.startCapital);
                if (data.equityInjections) setEquityInjections(data.equityInjections);
                if (data.loans) setLoans(data.loans);
                if (data.products) setProducts(data.products);
                if (data.inventoryItems) setInventoryItems(data.inventoryItems);
                if (data.consultants) setConsultants(data.consultants);
                if (data.otherCosts) setOtherCosts(data.otherCosts);
            } catch (err) { console.error(err); }
        };
        reader.readAsText(file);
    };

    // --- Financial Engine ---

    const financials = useMemo(() => {
        let monthlyRevenueOneOff = Array(12).fill(0);
        let monthlyRevenueRecurring = Array(12).fill(0);
        let monthlyTotalRevenue = Array(12).fill(0);
        
        let monthlyUnitsByBaseId = {};
        inventoryItems.forEach(i => monthlyUnitsByBaseId[i.id] = Array(12).fill(0));
        let accumulatedTotalUnits = Array(12).fill(0); 
        let currentCumUnits = 0;

        // ... existing code ... (Revenue loop logic unchanged)
        MONTHS.forEach((_, m) => {
            let monthOneOff = 0;
            let monthRecur = 0;

            products.forEach(p => {
                const unitsSold = salesInput[p.id] ? salesInput[p.id][m] : 0;
                
                if(p.baseId && monthlyUnitsByBaseId[p.baseId]) {
                    monthlyUnitsByBaseId[p.baseId][m] += unitsSold;
                }

                monthOneOff += unitsSold * p.price;

                let cumulativeUnits = 0;
                for(let i=0; i<=m; i++) {
                    cumulativeUnits += (salesInput[p.id] ? salesInput[p.id][i] : 0);
                }
                monthRecur += cumulativeUnits * p.sub;
            });

            let unitsThisMonthAllProds = 0;
            products.forEach(p => {
                if(p.baseId && p.baseId.startsWith('sys_')) {
                    unitsThisMonthAllProds += (salesInput[p.id] ? salesInput[p.id][m] : 0);
                }
            });
            currentCumUnits += unitsThisMonthAllProds;
            accumulatedTotalUnits[m] = currentCumUnits;

            monthlyRevenueOneOff[m] = monthOneOff;
            monthlyRevenueRecurring[m] = monthRecur;
            monthlyTotalRevenue[m] = monthOneOff + monthRecur;
        });

        // Inventory Logic
        let monthlyCOGSCash = Array(12).fill(0);
        let monthlyCOGSAcc = Array(12).fill(0);
        let inventoryStatus = {}; 
        let negativeStockEvents = []; // NEW: Track negative stock issues

        inventoryItems.forEach(item => {
            let currentStock = item.initialStock;
            let stockHistory = [];
            let purchases = Array(12).fill(0);
            let itemAccCogs = Array(12).fill(0);
            let demandHistory = Array(12).fill(0);
            let demandNext2M = Array(12).fill(0);

            for (let m = 0; m < 12; m++) {
                const arriving = (m >= 2) ? purchases[m-2] : 0;
                currentStock += arriving;

                const demand = monthlyUnitsByBaseId[item.id] ? monthlyUnitsByBaseId[item.id][m] : 0;
                demandHistory[m] = demand;
                itemAccCogs[m] = demand * item.cost;
                currentStock -= demand;

                // CHECK: Negative Inventory
                if (currentStock < 0) {
                    negativeStockEvents.push({ month: MONTHS[m], item: item.name, deficit: Math.abs(currentStock) });
                }

                const demandNext = (m < 11) && monthlyUnitsByBaseId[item.id] ? monthlyUnitsByBaseId[item.id][m+1] : 0;
                const demandNext2 = (m < 10) && monthlyUnitsByBaseId[item.id] ? monthlyUnitsByBaseId[item.id][m+2] : 0;
                demandNext2M[m] = demandNext + demandNext2;

                if ((currentStock - demandNext) < demandNext2) {
                    // DYNAMIC BATCHING: Buy at least 10, or cover shortfall + buffer
                    const projectedShortfall = (demandNext + demandNext2) - currentStock;
                    const batchSize = Math.max(10, projectedShortfall + 10);
                    
                    purchases[m] = batchSize;
                    monthlyCOGSCash[m] += (batchSize * item.cost);
                }
                stockHistory.push(currentStock);
            }
            
            inventoryStatus[item.id] = { stock: stockHistory, purchases: purchases, demand: demandHistory, next2Demand: demandNext2M };
            for(let i=0; i<12; i++) monthlyCOGSAcc[i] += itemAccCogs[i];
        });

        // OPEX (Split Acc vs Cash)
        let monthlyStaffCostAcc = Array(12).fill(0);
        let monthlyStaffCostCash = Array(12).fill(0);
        let monthlyFTE = Array(12).fill(0);
        
        staff.forEach(role => {
            if(role.count) {
                role.count.forEach((count, m) => {
                    // Accounting: Flat accrual
                    const monthlyBaseAcc = (role.salary * role.social) / 12;
                    
                    // Cash: Spike in June ONLY if not startup year
                    let monthlyBaseCash = monthlyBaseAcc; 
                    
                    // FIX: If Startup Year, no holiday pay spike (regular salary). 
                    // If Year 2+, assume holiday pay spike (approx 1.5x of base cost to cover extra payout)
                    if (!isStartupYear && m === 5) {
                        monthlyBaseCash *= 1.5; 
                    }
                    
                    monthlyStaffCostAcc[m] += (monthlyBaseAcc * count);
                    monthlyStaffCostCash[m] += (monthlyBaseCash * count);
                    monthlyFTE[m] += count;
                });
            }
        });

        // ... existing code ... (Consultants, Cloud, Fixed Costs logic unchanged)
        // Consultants - Logic to sum dynamically
        let monthlyConsultantCost = Array(12).fill(0);
        consultants.forEach(c => {
            if (c.costs && Array.isArray(c.costs)) {
                c.costs.forEach((cost, m) => {
                    monthlyConsultantCost[m] += cost;
                });
            }
        });

        let monthlyCloudCost = accumulatedTotalUnits.map(u => 2500 + (20 * u));

        let monthlyFixedTotal = Array(12).fill(0);
        let monthlyOtherOpCost = Array(12).fill(0);
        let monthlyVatableOps = Array(12).fill(0);

        MONTHS.forEach((_, m) => {
            let other = 0;
            let vatable = 0;
            
            otherCosts.forEach(fc => {
                other += fc.monthly;
                if(fc.vat) vatable += fc.monthly;
            });
            
            monthlyOtherOpCost[m] = other;
            
            // VAT Logic for variable/consultants
            // Consultants are VATable
            vatable += monthlyConsultantCost[m];
            // Cloud is VATable
            vatable += monthlyCloudCost[m];

            monthlyFixedTotal[m] = other + monthlyCloudCost[m] + monthlyConsultantCost[m];
            monthlyVatableOps[m] = vatable;
        });

        // Finance (Multiple Loans Support)
        let monthlyInterest = Array(12).fill(0);
        let monthlyPrincipal = Array(12).fill(0);
        let monthlyLoanCashOut = Array(12).fill(0);
        let monthlyLoanPayouts = Array(12).fill(0); 

        loans.forEach(loan => {
            if (!loan.active) return;

            const loanAmount = loan.amount;
            const interestRate = loan.interestRate / 100;
            const termMonths = loan.termYears * 12;
            const grace = loan.gracePeriod;
            const startM = loan.startMonth;

            let balance = loanAmount;
            const principalPayment = loanAmount / termMonths;
            const fee = loanAmount * (loan.feeRate / 100);

            if(startM < 12) {
                monthlyLoanPayouts[startM] += loanAmount;
                monthlyInterest[startM] += fee;
                monthlyLoanCashOut[startM] += fee;
            }

            for(let m = 0; m < 12; m++) {
                if (m >= startM) {
                    const interest = balance * (interestRate / 12);
                    monthlyInterest[m] += interest;
                    
                    let principal = 0;
                    if (m >= (startM + grace)) {
                        principal = principalPayment;
                        balance -= principal;
                        if(balance < 0) balance = 0;
                    }
                    
                    monthlyPrincipal[m] += principal;
                    monthlyLoanCashOut[m] += (interest + principal);
                }
            }
        });

        // VAT & Cash
        let monthlyVatIn = monthlyTotalRevenue.map(r => r * 0.25);
        let monthlyVatOut = monthlyCOGSCash.map((c, i) => (c + monthlyVatableOps[i]) * 0.25);
        let monthlyVatSettlement = Array(12).fill(0);
        const vatPayMonths = [3, 5, 7, 9, 11];
        
        vatPayMonths.forEach((payMonth, idx) => {
            const m1 = idx * 2;
            const m2 = m1 + 1;
            const netVat = (monthlyVatIn[m1] + monthlyVatIn[m2]) - (monthlyVatOut[m1] + monthlyVatOut[m2]);
            monthlyVatSettlement[payMonth] = netVat;
        });

        let cashBalance = Array(12).fill(0);
        let currentCash = startCapital;

        let monthlyCashIn = Array(12).fill(0);
        let monthlyCashOut = Array(12).fill(0);
        let monthlyFCF = Array(12).fill(0); // Free Cash Flow

        MONTHS.forEach((_, m) => {
            let eqIn = 0;
            equityInjections.forEach(e => {
                if(e.month === m) eqIn += e.amount;
            });
            
            // LIQUIDITY LAG: Revenue (incl VAT) delayed by 1 month (30 days terms)
            const revenueCashIn = (m > 0) ? (monthlyTotalRevenue[m-1] * 1.25) : 0;

            const inFlow = revenueCashIn + monthlyLoanPayouts[m] + eqIn;
            
            // Outflow
            const purchOut = monthlyCOGSCash[m] * 1.25;
            const staffOut = monthlyStaffCostCash[m]; // Use Cash version for liquidity
            
            let nonVatFixed = 0;
            otherCosts.forEach(fc => { if(!fc.vat) nonVatFixed += fc.monthly; });
            const opsOut = (monthlyVatableOps[m] * 1.25) + nonVatFixed;
            const loanOut = monthlyLoanCashOut[m];
            const vatPay = monthlyVatSettlement[m];
            
            const outFlow = purchOut + staffOut + opsOut + loanOut + vatPay;

            currentCash = currentCash + inFlow - outFlow;
            monthlyCashIn[m] = inFlow;
            monthlyCashOut[m] = outFlow;
            cashBalance[m] = currentCash;
        });

        let monthlyEBITDA = Array(12).fill(0);
        let monthlyNetResult = Array(12).fill(0);
        let monthlyGM = Array(12).fill(0); // Gross Margin %
        let monthlyEBT = Array(12).fill(0);

        MONTHS.forEach((_, m) => {
            const grossProfit = monthlyTotalRevenue[m] - monthlyCOGSAcc[m];
            if(monthlyTotalRevenue[m] > 0) {
                monthlyGM[m] = (grossProfit / monthlyTotalRevenue[m]) * 100;
            }

            const opex = monthlyStaffCostAcc[m] + monthlyFixedTotal[m];
            const ebitda = grossProfit - opex;
            const ebt = ebitda - monthlyInterest[m];
            
            monthlyEBITDA[m] = ebitda;
            monthlyEBT[m] = ebt;
            monthlyFCF[m] = ebitda - (monthlyCOGSCash[m]*1.25) - monthlyPrincipal[m] - monthlyVatSettlement[m]; 
        });

        // --- Annual Tax Calculation ---
        const totalYearEBT = monthlyEBT.reduce((acc, val) => acc + val, 0);
        const totalYearTax = totalYearEBT > 0 ? totalYearEBT * 0.22 : 0;
        const monthlyTaxDed = totalYearTax / 12;

        monthlyEBT.forEach((ebt, m) => {
            monthlyNetResult[m] = ebt - monthlyTaxDed;
        });

        return {
            revenue: { oneOff: monthlyRevenueOneOff, recurring: monthlyRevenueRecurring, total: monthlyTotalRevenue },
            cogs: { cash: monthlyCOGSCash, acc: monthlyCOGSAcc, inventory: inventoryStatus },
            opex: { 
                staff: monthlyStaffCostAcc, 
                fixed: monthlyFixedTotal, 
                consultants: monthlyConsultantCost,
                cloud: monthlyCloudCost,
                other: monthlyOtherOpCost,
                fte: monthlyFTE
            },
            finance: { interest: monthlyInterest, principal: monthlyPrincipal },
            liquidity: { balance: cashBalance, in: monthlyCashIn, out: monthlyCashOut, vatSettlement: monthlyVatSettlement },
            pnl: { ebitda: monthlyEBITDA, net: monthlyNetResult, gm: monthlyGM, fcf: monthlyFCF },
            alerts: { negativeStock: negativeStockEvents } // Return alerts
        };

    }, [salesInput, staff, startCapital, equityInjections, loans, products, inventoryItems, otherCosts, consultants, isStartupYear]);

    // ... CSV Export unchanged ...
    const handleCSVExport = () => {
        // ... same implementation ...
        let content = "\uFEFF"; 
        content += "Category;Jan;Feb;Mar;Apr;May;Jun;Jul;Aug;Sep;Oct;Nov;Dec;Total\n";
        const addRow = (name, arr) => {
            const total = arr.reduce((a,b)=>a+b,0);
            content += `${name};${arr.map(n => Math.round(n)).join(';')};${Math.round(total)}\n`;
        };
        addRow("Revenue", financials.revenue.total);
        addRow("COGS", financials.cogs.acc);
        addRow("Staff Costs", financials.opex.staff);
        addRow("Consultants", financials.opex.consultants);
        addRow("Fixed Costs", financials.opex.fixed);
        addRow("EBITDA", financials.pnl.ebitda);
        addRow("Net Result", financials.pnl.net);
        addRow("Liquidity Balance", financials.liquidity.balance);
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "styrebudsjett_2026.csv";
        a.click();
    };

    // ... Analysis Data unchanged ...
    const analysisData = useMemo(() => {
        return MONTHS.map((m, i) => ({
            name: m,
            EBITDA: financials.pnl.ebitda[i],
            NetResult: financials.pnl.net[i],
            GM: financials.pnl.gm[i],
            Staff: financials.opex.staff[i],
            Consultants: financials.opex.consultants[i],
            Cloud: financials.opex.cloud[i],
            Other: financials.opex.other[i],
            ARR: financials.revenue.recurring[i],
            Cash: financials.liquidity.balance[i],
            FTE: financials.opex.fte[i],
            FCF: financials.pnl.fcf[i],
            InvStock: selectedInventoryItem ? (financials.cogs.inventory[selectedInventoryItem]?.stock[i] || 0) : 0,
            InvDemandNext2M: selectedInventoryItem ? (financials.cogs.inventory[selectedInventoryItem]?.next2Demand[i] || 0) : 0,
        }));
    }, [financials, selectedInventoryItem]);

    return (
        <div className="min-h-screen bg-zinc-950 text-zinc-200 font-sans selection:bg-emerald-500/30 pb-20">
            {/* Header */}
            {/* ... Same header logic ... */}
            <header className="sticky top-0 z-50 bg-zinc-950/80 backdrop-blur border-b border-zinc-800 px-6 py-4 flex justify-between items-center">
                <div className="flex items-center gap-3">
                    <img src="https://storage.googleapis.com/files_webpage/A.png" alt="Alphatek Icon" className="w-8 h-8 object-contain" />
                    <div>
                        <h1 className="text-lg font-bold leading-tight">Alphatek Financials</h1>
                    </div>
                </div>
                <div className="flex gap-3">
                    <label className="flex items-center gap-2 px-3 py-1.5 rounded bg-zinc-900 border border-zinc-800 text-xs hover:bg-zinc-800 cursor-pointer transition">
                        <Upload size={14} /> Import
                        <input type="file" className="hidden" accept=".json" onChange={handleImport} />
                    </label>
                    <button onClick={handleExport} className="flex items-center gap-2 px-3 py-1.5 rounded bg-zinc-900 border border-zinc-800 text-xs hover:bg-zinc-800 transition">
                        <Save size={14} /> Export JSON
                    </button>
                </div>
            </header>

            {/* Navigation */}
            {/* ... Same nav ... */}
            <nav className="flex gap-1 px-6 border-b border-zinc-800 bg-zinc-900/50 overflow-x-auto">
                {[
                    { id: 'intro', icon: Info, label: 'Intro' },
                    { id: 'revenue', icon: TrendingUp, label: 'Revenue' },
                    { id: 'costs', icon: Package, label: 'Variable Costs' },
                    { id: 'opex', icon: Users, label: 'Fixed Costs' },
                    { id: 'liquidity', icon: Landmark, label: 'Liquidity' },
                    { id: 'board', icon: FileSpreadsheet, label: 'Board Budget' },
                    { id: 'analysis', icon: Activity, label: 'Analysis' }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${
                            activeTab === tab.id 
                                ? 'border-blue-500 text-white' 
                                : 'border-transparent text-zinc-500 hover:text-zinc-300'
                        }`}
                    >
                        <tab.icon size={16} /> {tab.label}
                    </button>
                ))}
            </nav>

            <main className="max-w-7xl mx-auto p-6 space-y-8">

                {/* --- TAB: INTRO --- */}
                {activeTab === 'intro' && (
                    <div className="space-y-8 max-w-5xl mx-auto">
                        {/* ... Intro Content ... */}
                        <div className="text-center space-y-4 mb-8">
                            <h2 className="text-3xl font-bold text-white">Alphatek Financial Model 2026</h2>
                            <p className="text-zinc-400">A simulation tool for strategic decision making</p>
                        </div>

                        {/* NEW: Global Settings Config in Intro */}
                        <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div>
                                <h3 className="text-lg font-bold text-white flex items-center gap-2"><Settings size={18}/> Model Configuration</h3>
                                <p className="text-sm text-zinc-400">Global settings for the simulation year</p>
                            </div>
                            <div className="flex items-center gap-4">
                                <label className="flex items-center gap-3 cursor-pointer group">
                                    <div className={`w-12 h-6 rounded-full relative transition-colors ${isStartupYear ? 'bg-emerald-600' : 'bg-zinc-700'}`}>
                                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${isStartupYear ? 'left-7' : 'left-1'}`}></div>
                                    </div>
                                    <div className="text-sm">
                                        <div className="font-bold text-zinc-200">Startup Year (Year 1)</div>
                                        <div className="text-xs text-zinc-500 group-hover:text-zinc-400">Disables holiday pay payout in June</div>
                                    </div>
                                    <input type="checkbox" className="hidden" checked={isStartupYear} onChange={() => setIsStartupYear(!isStartupYear)} />
                                </label>
                            </div>
                        </div>

                        <div className="bg-zinc-900/40 border border-zinc-800 rounded-xl p-8">
                            {/* ... Glossary Content ... */}
                            <h3 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                                <BookOpen size={28} className="text-blue-400"/> Glossary of Terms Used in Alphatek Financials
                            </h3>
                            {/* ... existing glossary content ... */}
                            <div className="grid md:grid-cols-2 gap-8">
                                {/* Revenue */}
                                <div className="space-y-4">
                                    <h4 className="text-xl font-bold text-blue-400 border-b border-blue-500/30 pb-2 flex items-center gap-2"><TrendingUp size={20}/> Revenue</h4>
                                    
                                    <div>
                                        <div className="font-bold text-zinc-200">One-Off Revenue</div>
                                        <div className="text-sm text-zinc-400 mb-1">Upfront income from hardware purchases or setup fees.</div>
                                        <div className="text-xs font-mono text-zinc-500 bg-zinc-900/50 p-2 rounded border border-zinc-800">
                                            Calculated as: units sold × start price for each month.
                                        </div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Recurring Revenue (Subscription Revenue)</div>
                                        <div className="text-sm text-zinc-400 mb-1">Monthly subscription income from all active systems.</div>
                                        <div className="text-xs font-mono text-zinc-500 bg-zinc-900/50 p-2 rounded border border-zinc-800">
                                            Calculated as: active units to date × monthly subscription price.
                                        </div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">ARR (Annual Recurring Revenue)</div>
                                        <div className="text-sm text-zinc-400 mb-1">The annualized value of recurring revenue based on the December run rate.</div>
                                        <div className="text-xs font-mono text-zinc-500 bg-zinc-900/50 p-2 rounded border border-zinc-800">
                                            Formula: December recurring × 12.
                                        </div>
                                    </div>
                                </div>

                                {/* COGS */}
                                <div className="space-y-4">
                                    <h4 className="text-xl font-bold text-rose-400 border-b border-rose-500/30 pb-2 flex items-center gap-2"><Package size={20}/> COGS / Cost of Goods Sold</h4>
                                    <div>
                                        <div className="font-bold text-zinc-200">Accounting COGS</div>
                                        <div className="text-sm text-zinc-400 mb-1">The cost of units delivered to customers in a given month. Affects gross profit, EBITDA, and net result.</div>
                                        <div className="text-xs font-mono text-zinc-500 bg-zinc-900/50 p-2 rounded border border-zinc-800">
                                            Formula: units delivered × production cost per unit.
                                        </div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Cash COGS</div>
                                        <div className="text-sm text-zinc-400 mb-1">Actual cash payments made to purchase inventory. Recognized when the order is placed and paid. Affects liquidity, not profit.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Inventory</div>
                                        <div className="text-sm text-zinc-400 mb-1">Stock of units available. Updated when new batches are ordered, deliveries arrive, or units are delivered.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Auto-Replenishment</div>
                                        <div className="text-sm text-zinc-400 mb-1">The model automatically orders a fixed batch (e.g., 10 units) when projected stock will not meet upcoming demand 1–2 months ahead.</div>
                                    </div>
                                </div>

                                {/* OPEX */}
                                <div className="space-y-4">
                                    <h4 className="text-xl font-bold text-purple-400 border-b border-purple-500/30 pb-2 flex items-center gap-2"><Users size={20}/> OPEX / Operating Expenses</h4>
                                    <div>
                                        <div className="font-bold text-zinc-200">Staff Costs</div>
                                        <div className="text-sm text-zinc-400 mb-1">Salary plus social costs (tax, pension, etc.). An extra half-month is added in June to simulate holiday pay.</div>
                                        <div className="text-xs font-mono text-zinc-500 bg-zinc-900/50 p-2 rounded border border-zinc-800">
                                            Calculated as: annual salary × social factor ÷ 12 × number of FTEs.
                                        </div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Consultants</div>
                                        <div className="text-sm text-zinc-400 mb-1">External service providers. Calculated as monthly rate × quantity.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Cloud Costs</div>
                                        <div className="text-sm text-zinc-400 mb-1">Usage-based cloud expenses that grow with the number of active systems: base fee + cost per active system.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Other OPEX</div>
                                        <div className="text-sm text-zinc-400 mb-1">Fixed monthly operating costs such as office rent, electricity, software, travel, marketing, etc. Each cost is marked as either with VAT or without VAT.</div>
                                    </div>
                                </div>

                                {/* VAT */}
                                <div className="space-y-4">
                                    <h4 className="text-xl font-bold text-indigo-400 border-b border-indigo-500/30 pb-2 flex items-center gap-2"><Landmark size={20}/> VAT / Value Added Tax</h4>
                                    <div>
                                        <div className="font-bold text-zinc-200">VAT In</div>
                                        <div className="text-sm text-zinc-400 mb-1">25% VAT charged on all revenue. Collected from customers → increases cash.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">VAT Out</div>
                                        <div className="text-sm text-zinc-400 mb-1">25% VAT paid on inventory purchases and all VAT-liable operating costs.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">VAT Settlement</div>
                                        <div className="text-sm text-zinc-400 mb-1">Every second month, the model settles VAT: VAT in − VAT out. Paid to or refunded from the tax authorities.</div>
                                    </div>
                                </div>

                                {/* Finance */}
                                <div className="space-y-4">
                                    <h4 className="text-xl font-bold text-amber-400 border-b border-amber-500/30 pb-2 flex items-center gap-2"><CreditCard size={20}/> Finance</h4>
                                    <div>
                                        <div className="font-bold text-zinc-200">Loan</div>
                                        <div className="text-sm text-zinc-400 mb-1">Defined by loan amount, interest rate, term, fee, and grace period.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Interest</div>
                                        <div className="text-sm text-zinc-400 mb-1">Monthly interest expense based on remaining loan balance.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Principal</div>
                                        <div className="text-sm text-zinc-400 mb-1">Amount of the loan repaid each month (linear repayment).</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Fee</div>
                                        <div className="text-sm text-zinc-400 mb-1">One-time setup fee charged at loan start.</div>
                                    </div>
                                </div>

                                {/* Liquidity */}
                                <div className="space-y-4">
                                    <h4 className="text-xl font-bold text-green-400 border-b border-green-500/30 pb-2 flex items-center gap-2"><Wallet size={20}/> Liquidity</h4>
                                    <div>
                                        <div className="font-bold text-zinc-200">Cash In</div>
                                        <ul className="list-disc list-inside text-sm text-zinc-400 ml-1">
                                            <li>Revenue including VAT</li>
                                            <li>Equity injections</li>
                                            <li>Loan proceeds</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Cash Out</div>
                                        <ul className="list-disc list-inside text-sm text-zinc-400 ml-1">
                                            <li>Inventory purchases including VAT</li>
                                            <li>Staff and consultant costs</li>
                                            <li>All OPEX including VAT where applicable</li>
                                            <li>VAT settlements</li>
                                            <li>Interest and principal payments</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Cash Balance</div>
                                        <div className="text-sm text-zinc-400 mb-1">Running cash position month by month.</div>
                                    </div>
                                </div>

                                {/* P&L */}
                                <div className="space-y-4">
                                    <h4 className="text-xl font-bold text-orange-400 border-b border-orange-500/30 pb-2 flex items-center gap-2"><FileSpreadsheet size={20}/> P&L / Profit & Loss</h4>
                                    <div>
                                        <div className="font-bold text-zinc-200">Gross Profit</div>
                                        <div className="text-sm text-zinc-400 mb-1">Revenue – Accounting COGS</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">EBITDA</div>
                                        <div className="text-sm text-zinc-400 mb-1">Gross profit – OPEX (staff + consultants + cloud + other)</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">EBT (Earnings Before Tax)</div>
                                        <div className="text-sm text-zinc-400 mb-1">EBITDA – interest expenses</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Tax</div>
                                        <div className="text-sm text-zinc-400 mb-1">22% of positive earnings before tax.</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-zinc-200">Net Result</div>
                                        <div className="text-sm text-zinc-400 mb-1">EBT – tax</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* --- TAB: REVENUE --- */}
                {/* ... existing Revenue code ... */}
                {activeTab === 'revenue' && (
                    <div className="space-y-6">
                        {/* ... (Revenue content same as before) ... */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <KpiCard title="Total Revenue" value={formatNOK(financials.revenue.total.reduce((a,b)=>a+b,0))} sub="FY 2026 Forecast" color="text-emerald-400" />
                            <KpiCard title="Recurring Revenue" value={formatNOK(financials.revenue.recurring[11])} sub="December ARR Run-rate" color="text-blue-400" />
                            <KpiCard title="One-Off Sales" value={formatNOK(financials.revenue.oneOff.reduce((a,b)=>a+b,0))} sub="Total Contract Value" color="text-zinc-400" />
                        </div>

                        <div className="h-80 bg-zinc-900/40 border border-zinc-800 rounded-xl p-4">
                            <h3 className="text-sm font-semibold text-zinc-400 mb-4">Revenue Mix</h3>
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={MONTHS.map((m, i) => ({ 
                                    name: m, 
                                    OneOff: financials.revenue.oneOff[i], 
                                    Recurring: financials.revenue.recurring[i] 
                                }))}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                    <XAxis dataKey="name" stroke="#52525b" fontSize={12} />
                                    <YAxis stroke="#52525b" fontSize={12} tickFormatter={(v) => `${v/1000}k`} />
                                    <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                    <Legend />
                                    <Bar dataKey="OneOff" stackId="a" fill="#52525b" name="One-Off" />
                                    <Bar dataKey="Recurring" stackId="a" fill="#3b82f6" name="Recurring (Sub)" />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>

                        {/* Separate Input Tables by Category */}
                        <div className="space-y-12">
                            {[
                                { title: "Rental Agreements (Recurring)", type: 'agreement' },
                                { title: "Hardware Purchases (One-Off)", type: 'purchase' },
                                { title: "Add-ons & Extras", type: 'addon' }
                            ].map((group, idx) => (
                                <div key={idx} className="bg-zinc-900/40 border border-zinc-800 rounded-xl overflow-hidden shadow-lg">
                                    <div className="px-4 py-3 border-b border-zinc-800 bg-zinc-900/50 flex justify-between items-center">
                                        <h3 className="text-sm font-bold text-zinc-300">{group.title}</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead>
                                                <tr className="text-zinc-500 text-xs uppercase bg-zinc-900/50">
                                                    <th className="px-4 py-3 font-medium">Product</th>
                                                    {MONTHS.map(m => <th key={m} className="px-2 py-3 text-center min-w-[50px]">{m}</th>)}
                                                    <th className="px-4 py-3 text-center font-bold text-zinc-300">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-zinc-800">
                                                {products.filter(p => p.type === group.type).map(p => (
                                                    <tr key={p.id} className="hover:bg-zinc-900/30 group">
                                                        <td className="px-4 py-3">
                                                            <div className="flex items-center gap-4">
                                                                <div className="w-16 h-16 bg-white rounded flex-shrink-0 flex items-center justify-center overflow-hidden border border-zinc-700">
                                                                    {p.img ? (
                                                                        <img src={p.img} alt={p.name} className="w-full h-full object-contain p-1" />
                                                                    ) : (
                                                                        <Box className="text-zinc-400" size={24} />
                                                                    )}
                                                                </div>
                                                                <div className="flex-1 min-w-[160px]">
                                                                    <div className="font-medium text-base text-zinc-200">
                                                                        {p.name}
                                                                    </div>
                                                                    <div className="text-[10px] text-zinc-500 flex gap-2 mt-1">
                                                                        <span>Start: {formatNOK(p.price)}</span>
                                                                        {p.sub > 0 && <span>/ Rec: {formatNOK(p.sub)}</span>}
                                                                    </div>
                                                                </div>
                                                                {/* Permanent Settings Icon */}
                                                                <button 
                                                                    onClick={() => setEditingProduct(p)}
                                                                    className="text-zinc-500 hover:text-white transition-colors p-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg border border-zinc-700 mr-2"
                                                                    title="Product Settings"
                                                                >
                                                                    <Settings size={16} />
                                                                </button>
                                                            </div>
                                                        </td>
                                                        {MONTHS.map((m, i) => (
                                                            <td key={i} className="px-1 py-1">
                                                                <input 
                                                                    type="number" 
                                                                    min="0"
                                                                    value={salesInput[p.id] ? salesInput[p.id][i] : 0}
                                                                    onChange={(e) => handleSalesChange(p.id, i, e.target.value)}
                                                                    onWheel={safeInput}
                                                                    className="w-full bg-transparent text-center border border-transparent hover:border-zinc-700 focus:border-blue-500 focus:bg-zinc-900 rounded py-1 outline-none transition-all text-zinc-300"
                                                                />
                                                            </td>
                                                        ))}
                                                        <td className="px-4 py-1 text-center font-bold text-zinc-300">
                                                            {salesInput[p.id] ? salesInput[p.id].reduce((a, b) => a + b, 0) : 0}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="bg-zinc-900/30 p-2 border-t border-zinc-800">
                                        <button 
                                            onClick={() => handleAddProduct(group.type)}
                                            className="text-xs flex items-center gap-2 text-zinc-500 hover:text-zinc-300 px-2 py-1 rounded hover:bg-zinc-800/50 transition-colors"
                                        >
                                            <Plus size={14} /> Add Product
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* ... existing Costs code ... */}
                {activeTab === 'costs' && (
                    <div className="space-y-6">
                        {/* ... (Costs content same as before) ... */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <KpiCard title="Total COGS (Accounting)" value={formatNOK(financials.cogs.acc.reduce((a,b)=>a+b,0))} sub="Impacts P&L" color="text-rose-400" />
                            <KpiCard title="Purchasing Cash Out" value={formatNOK(financials.cogs.cash.reduce((a,b)=>a+b,0))} sub="Impacts Liquidity (Batched)" color="text-amber-400" />
                        </div>

                        <div className="h-64 bg-zinc-900/40 border border-zinc-800 rounded-xl p-4">
                            <h3 className="text-sm font-semibold text-zinc-400 mb-4">Purchasing Cash Flow</h3>
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={MONTHS.map((m, i) => ({ name: m, Cash: financials.cogs.cash[i] }))}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                    <XAxis dataKey="name" stroke="#52525b" fontSize={12} />
                                    <YAxis stroke="#52525b" fontSize={12} tickFormatter={(v) => `${v/1000}k`} />
                                    <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                    <Bar dataKey="Cash" fill="#f59e0b" radius={[4,4,0,0]} name="Cash Out" />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {inventoryItems.map(item => {
                                const status = financials.cogs.inventory[item.id];
                                return (
                                    <div key={item.id} className="bg-zinc-900/40 border border-zinc-800 rounded-xl p-4">
                                        <div className="flex justify-between items-start mb-4">
                                            <h4 className="font-bold text-sm text-zinc-300">{item.name}</h4>
                                            <span className="text-xs px-2 py-1 rounded bg-zinc-800 text-zinc-400">{formatNOK(item.cost)}</span>
                                        </div>
                                        <div className="flex items-end h-24 gap-1">
                                            {MONTHS.map((m, i) => {
                                                const stock = status?.stock[i] || 0;
                                                const bought = status?.purchases[i] > 0;
                                                const height = Math.min((stock / 20) * 100, 100); 
                                                const isNegative = stock < 0; // Check for negative stock
                                                return (
                                                    <div key={i} className="flex-1 flex flex-col justify-end gap-1 group relative">
                                                        {bought && <div className="w-full h-1 bg-amber-500 rounded-full mb-0.5"></div>}
                                                        <div 
                                                            className={`w-full rounded-sm hover:bg-zinc-600 transition-colors ${isNegative ? 'bg-rose-600' : 'bg-zinc-700'}`}
                                                            style={{ height: `${Math.max(Math.abs(height), 4)}%` }}
                                                        ></div>
                                                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-black text-xs p-2 rounded whitespace-nowrap z-20 border border-zinc-700 shadow-xl">
                                                            <div className="font-bold text-zinc-300">{m}</div>
                                                            <div className={isNegative ? 'text-rose-500 font-bold' : ''}>Stock: {stock}</div>
                                                            {bought && <div className="text-amber-500">Bought: {status.purchases[i]}</div>}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="flex justify-between mt-2 text-[10px] text-zinc-600 uppercase font-bold">
                                            <span>Jan</span>
                                            <span>Dec</span>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                )}

                {/* ... existing Opex code ... */}
                {activeTab === 'opex' && (
                    <div className="space-y-6">
                        <div className="h-72 bg-zinc-900/40 border border-zinc-800 rounded-xl p-4">
                             <h3 className="text-sm font-semibold text-zinc-400 mb-4">Total OPEX (Staff + Fixed)</h3>
                             <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={MONTHS.map((m, i) => ({ 
                                    name: m, 
                                    Staff: financials.opex.staff[i],
                                    Fixed: financials.opex.fixed[i]
                                }))}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                    <XAxis dataKey="name" stroke="#52525b" fontSize={12} />
                                    <YAxis stroke="#52525b" fontSize={12} tickFormatter={(v) => `${v/1000}k`} />
                                    <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                    <Legend />
                                    <Area type="monotone" dataKey="Staff" stackId="1" stroke="#8b5cf6" fill="#8b5cf6" fillOpacity={0.2} />
                                    <Area type="monotone" dataKey="Fixed" stackId="1" stroke="#ec4899" fill="#ec4899" fillOpacity={0.2} />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>

                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            {/* Staffing Table */}
                            <div className="bg-zinc-900/40 border border-zinc-800 rounded-xl overflow-hidden">
                                <div className="px-4 py-3 border-b border-zinc-800 bg-zinc-900/50 flex justify-between items-center">
                                    <h3 className="text-sm font-bold">Staffing (FTEs)</h3>
                                    <button onClick={handleAddRole} className="text-xs bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded flex items-center gap-1">
                                        <Plus size={12}/> Add
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs text-left">
                                        <thead>
                                            <tr>
                                                <th className="px-4 py-2 text-zinc-500">Role</th>
                                                {MONTHS.map((m) => <th key={m} className="px-1 py-2 text-center text-zinc-600">{m}</th>)}
                                                <th className="px-2 py-2 text-center text-zinc-300 font-bold">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-zinc-800">
                                            {staff.map(role => (
                                                <tr key={role.id} className="group hover:bg-zinc-900/30">
                                                    <td className="px-4 py-2">
                                                        <div className="flex items-center justify-between">
                                                            <span className="font-medium">{role.name}</span>
                                                            <button onClick={() => setEditingRole(role)} className="opacity-0 group-hover:opacity-100 p-1 hover:bg-zinc-700 rounded text-zinc-400">
                                                                <Settings size={12}/>
                                                            </button>
                                                        </div>
                                                    </td>
                                                    {role.count?.map((c, i) => (
                                                        <td key={i} className="px-1 py-1">
                                                            <input 
                                                                type="number" 
                                                                value={c}
                                                                onChange={(e) => {
                                                                    handleStaffCountChange(role.id, i, e.target.value);
                                                                }}
                                                                onWheel={safeInput}
                                                                className="w-full bg-zinc-900 border border-zinc-700 rounded text-center py-1 text-zinc-300 focus:border-blue-500 outline-none"
                                                            />
                                                        </td>
                                                    ))}
                                                    <td className="px-2 py-1 text-center font-bold text-zinc-300">
                                                        {role.count.reduce((a, b) => a + b, 0)}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div className="space-y-6">
                                {/* NEW: Consultants Section (Moved to Top) */}
                                <div className="bg-zinc-900/40 border border-zinc-800 rounded-xl overflow-hidden">
                                    <div className="px-4 py-3 border-b border-zinc-800 bg-zinc-900/50 flex justify-between items-center">
                                        <h3 className="text-sm font-bold">Consultants</h3>
                                        <button onClick={handleAddConsultant} className="text-xs bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded flex items-center gap-1">
                                            <UserPlus size={12}/> Add
                                        </button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-xs text-left">
                                            <thead>
                                                <tr>
                                                    <th className="px-4 py-2 text-zinc-500">Name</th>
                                                    {MONTHS.map((m) => <th key={m} className="px-1 py-2 text-center text-zinc-600">{m}</th>)}
                                                    <th className="px-2 py-2 text-center text-zinc-300 font-bold">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-zinc-800">
                                                {consultants.map(c => (
                                                    <tr key={c.id} className="group hover:bg-zinc-900/30">
                                                        <td className="px-4 py-2">
                                                            <div className="flex items-center justify-between">
                                                                <div>
                                                                    <div className="font-medium">{c.name}</div>
                                                                </div>
                                                                <button onClick={() => setEditingConsultant(c)} className="opacity-0 group-hover:opacity-100 p-1 hover:bg-zinc-700 rounded text-zinc-400">
                                                                    <Settings size={12}/>
                                                                </button>
                                                            </div>
                                                        </td>
                                                        {c.costs?.map((cost, i) => (
                                                            <td key={i} className="px-1 py-1">
                                                                <input 
                                                                    type="number" 
                                                                    value={cost}
                                                                    onChange={(e) => {
                                                                        handleConsultantCostChange(c.id, i, e.target.value);
                                                                    }}
                                                                    onWheel={safeInput}
                                                                    className="w-full bg-zinc-900 border border-zinc-700 rounded text-center py-1 text-zinc-300 focus:border-blue-500 outline-none"
                                                                    placeholder="Kr"
                                                                />
                                                            </td>
                                                        ))}
                                                        <td className="px-2 py-1 text-center font-bold text-zinc-300">
                                                            {formatCompactNOK(c.costs.reduce((a,b)=>a+b,0))}
                                                        </td>
                                                    </tr>
                                                ))}
                                                {consultants.length === 0 && (
                                                    <tr><td colSpan="14" className="text-center py-4 text-zinc-500 italic">No consultants added.</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Operational Costs List (Editable) */}
                                <div className="bg-zinc-900/40 border border-zinc-800 rounded-xl overflow-hidden">
                                    <div className="px-4 py-3 border-b border-zinc-800 bg-zinc-900/50 flex justify-between items-center">
                                        <h3 className="text-sm font-bold">Operational Costs (Monthly)</h3>
                                        <button onClick={handleAddOpCost} className="text-xs bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded flex items-center gap-1">
                                            <Plus size={12}/> Add
                                        </button>
                                    </div>
                                    <div className="divide-y divide-zinc-800">
                                        {otherCosts.map((fc, i) => (
                                            <div key={fc.id} className="flex justify-between items-center text-sm p-3 hover:bg-zinc-900 group">
                                                <div className="flex items-center gap-2">
                                                    <span>{fc.name}</span>
                                                    <button onClick={() => setEditingOpCost(fc)} className="opacity-0 group-hover:opacity-100 p-1 hover:bg-zinc-700 rounded text-zinc-400">
                                                        <Settings size={12}/>
                                                    </button>
                                                </div>
                                                <div className="flex gap-4 items-center">
                                                    <span className="text-xs text-zinc-600 uppercase">{fc.vat ? 'VAT' : 'No VAT'}</span>
                                                    <span className="font-mono">{formatNum(fc.monthly)}</span>
                                                    <span className="text-xs text-zinc-500 w-20 text-right">Year: {formatCompactNOK(fc.monthly*12)}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-3 bg-zinc-900/30 text-xs text-zinc-500 border-t border-zinc-800">
                                        + Variable Cloud Costs (Auto-calculated)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* --- TAB: LIQUIDITY --- */}
                {/* ... existing Liquidity code ... */}
                {activeTab === 'liquidity' && (
                    <div className="space-y-6">
                        {/* ... (Liquidity content same as before) ... */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="glass-panel p-4 rounded-xl border border-zinc-800 bg-zinc-900/40 flex flex-col gap-4">
                                <div>
                                    <label className="text-xs text-zinc-500 uppercase font-bold">Start Capital</label>
                                    <div className="relative mt-1">
                                        <span className="absolute left-3 top-2.5 text-zinc-500 text-xs font-bold">kr</span>
                                        <input 
                                            type="number" 
                                            value={startCapital} 
                                            onChange={(e) => setStartCapital(parseFloat(e.target.value))}
                                            onWheel={safeInput}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded pl-8 p-2 text-zinc-200 focus:ring-1 focus:ring-emerald-500 outline-none"
                                        />
                                    </div>
                                </div>
                                <div className="p-3 rounded bg-zinc-950 border border-zinc-800 space-y-2">
                                    <div className="flex items-center justify-between">
                                        <span className="text-sm font-medium flex items-center gap-2"><CreditCard size={14}/> Loans</span>
                                        <button onClick={handleAddLoan} className="text-xs bg-zinc-800 p-1 rounded hover:bg-zinc-700"><Plus size={12}/></button>
                                    </div>
                                    {loans.map(l => (
                                        <div key={l.id} className="flex justify-between items-center text-xs group">
                                            <div className="flex flex-col">
                                                <span className={`${l.active ? 'text-zinc-300' : 'text-zinc-600 line-through'}`}>{l.name}</span>
                                                <span className="text-[9px] text-zinc-500">{formatCompactNOK(l.amount)}</span>
                                            </div>
                                            <div className="flex gap-1">
                                                <button onClick={() => setEditingLoan(l)} className="text-zinc-500 hover:text-white"><Settings size={12}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="md:col-span-3 h-72 bg-zinc-900/40 border border-zinc-800 rounded-xl p-4">
                                <h3 className="text-sm font-semibold text-zinc-400 mb-2">Liquidity Forecast</h3>
                                <ResponsiveContainer width="100%" height="100%">
                                    <ComposedChart data={MONTHS.map((m, i) => ({ 
                                        name: m, 
                                        Balance: financials.liquidity.balance[i],
                                        In: financials.liquidity.in[i],
                                        Out: -financials.liquidity.out[i]
                                    }))}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                        <XAxis dataKey="name" stroke="#52525b" fontSize={12} />
                                        <YAxis stroke="#52525b" fontSize={12} tickFormatter={(v) => `${v/1000}k`} />
                                        <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} formatter={(v) => formatNOK(Math.abs(v))} />
                                        <Legend />
                                        <ReferenceLine y={0} stroke="#ef4444" strokeDasharray="3 3" />
                                        <Bar dataKey="In" fill="#10b981" barSize={12} stackId="a" />
                                        <Bar dataKey="Out" fill="#f43f5e" barSize={12} stackId="a" />
                                        <Line type="monotone" dataKey="Balance" stroke="#3b82f6" strokeWidth={3} dot={false} />
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* --- Inventory Stock Adjustments --- */}
                        <div className="bg-zinc-900/40 border border-zinc-800 rounded-xl p-4">
                            <h3 className="text-sm font-semibold mb-3 text-zinc-400">Initial Inventory (Units in Stock Jan 1)</h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                {inventoryItems.map(item => (
                                    <div key={item.id}>
                                        <label className="text-[10px] text-zinc-500 block mb-1 truncate" title={item.name}>{item.name}</label>
                                        <input 
                                            type="number" 
                                            min="0"
                                            value={item.initialStock} 
                                            onChange={(e) => handleStockChange(item.id, e.target.value)}
                                            onWheel={safeInput}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200 focus:ring-1 focus:ring-emerald-500 outline-none text-center"
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* --- Equity Injections List --- */}
                        <div className="bg-zinc-900/40 border border-zinc-800 rounded-xl p-4">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-sm font-semibold text-zinc-400">Equity Injections</h3>
                                <button onClick={handleAddEquity} className="text-xs bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded flex items-center gap-1">
                                    <Plus size={12}/> Add Round
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {equityInjections.map(eq => (
                                    <div key={eq.id} className="bg-zinc-900 border border-zinc-800 p-3 rounded flex justify-between items-center group">
                                        <div>
                                            <div className="text-sm font-medium">{eq.name}</div>
                                            <div className="text-xs text-zinc-500">{formatCompactNOK(eq.amount)} in {MONTHS[eq.month]}</div>
                                        </div>
                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => setEditingEquity(eq)} className="p-1 hover:bg-zinc-800 rounded text-zinc-400"><Settings size={14}/></button>
                                        </div>
                                    </div>
                                ))}
                                {equityInjections.length === 0 && <div className="text-xs text-zinc-600 italic">No equity rounds added.</div>}
                            </div>
                        </div>
                    </div>
                )}

                {/* --- TAB: BOARD BUDGET --- */}
                {/* ... existing Board Budget code ... */}
                {activeTab === 'board' && (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h2 className="text-xl font-bold">P&L Summary 2026</h2>
                            <button onClick={handleCSVExport} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-sm font-medium transition flex items-center gap-2">
                                <FileSpreadsheet size={16} /> Download CSV
                            </button>
                        </div>

                        <div className="border border-zinc-800 rounded-xl overflow-hidden">
                            <table className="w-full text-sm">
                                <thead className="bg-zinc-900 text-zinc-400">
                                    <tr>
                                        <th className="px-6 py-4 text-left">Category</th>
                                        <th className="px-6 py-4 text-right">Year Total</th>
                                        <th className="px-6 py-4 text-right hidden sm:table-cell">Monthly Avg</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-zinc-800 bg-zinc-900/20">
                                    <SummaryRow label="Total Revenue" values={financials.revenue.total} bold />
                                    <SummaryRow label="One-off Revenue" values={financials.revenue.oneOff} muted />
                                    <SummaryRow label="Recurring Revenue (ARR)" values={financials.revenue.recurring} muted />
                                    <SummaryRow label="COGS" values={financials.cogs.acc} neg />
                                    <SummaryRow label="Gross Profit" values={financials.revenue.total.map((r,i) => r - financials.cogs.acc[i])} bold color="text-emerald-400" />
                                    <SummaryRow label="Staff Costs" values={financials.opex.staff} neg />
                                    <tr>
                                        <td className="px-6 py-2 text-xs text-zinc-500 italic pl-8">Average FTEs</td>
                                        <td className="px-6 py-2 text-right text-xs text-zinc-500 italic">-</td>
                                        <td className="px-6 py-2 text-right text-xs text-zinc-500 italic font-mono">
                                            {(financials.opex.fte.reduce((a,b)=>a+b,0)/12).toFixed(1)}
                                        </td>
                                    </tr>
                                    <SummaryRow label="Consultants" values={financials.opex.consultants} neg />
                                    <SummaryRow label="Other OPEX" values={financials.opex.fixed} neg />
                                    <SummaryRow label="EBITDA" values={financials.pnl.ebitda} bold highlight />
                                    <SummaryRow label="Depreciation" values={Array(12).fill(0)} neg muted />
                                    <SummaryRow label="Finance (Interest)" values={financials.finance.interest} neg />
                                    <SummaryRow label="Net Result" values={financials.pnl.net} bold color="text-blue-400" />
                                </tbody>
                            </table>
                        </div>

                        <div className="flex justify-end mt-8">
                            <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-xl text-right">
                                <h3 className="text-zinc-500 text-sm mb-1 uppercase tracking-wider">Liquidity Projection (31.12.2026)</h3>
                                <div className={`text-3xl font-bold ${financials.liquidity.balance[11] >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                    {formatNOK(financials.liquidity.balance[11])}
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* --- TAB: ANALYSIS --- */}
                {activeTab === 'analysis' && (
                    <div className="space-y-8">
                        {/* NEW: Inventory Warning Alert */}
                        {financials.alerts.negativeStock.length > 0 && (
                            <div className="bg-rose-900/20 border border-rose-900/50 rounded-xl p-4 flex items-start gap-3">
                                <AlertTriangle className="text-rose-500 flex-shrink-0" size={20} />
                                <div>
                                    <h4 className="text-rose-400 font-bold text-sm">Critical Logic Warning: Negative Inventory Detected</h4>
                                    <p className="text-rose-300/80 text-xs mt-1">
                                        The simulation detected sales exceeding available stock. This inflates revenue artificially. 
                                        In real life, these sales would be delayed until stock arrives.
                                    </p>
                                    <ul className="mt-2 text-xs text-rose-300/60 list-disc list-inside">
                                        {financials.alerts.negativeStock.slice(0,3).map((a, i) => (
                                            <li key={i}>{a.month}: {a.item} deficit of {a.deficit} units</li>
                                        ))}
                                        {financials.alerts.negativeStock.length > 3 && <li>...and {financials.alerts.negativeStock.length - 3} more instances.</li>}
                                    </ul>
                                </div>
                            </div>
                        )}

                        <div className="border border-zinc-800 rounded-xl overflow-x-auto bg-zinc-900/20">
                             <table className="w-full text-xs whitespace-nowrap">
                                <thead>
                                    <tr className="text-zinc-500 border-b border-zinc-800">
                                        <th className="text-left py-3 px-4 sticky left-0 bg-zinc-900">Month</th>
                                        {MONTHS.map(m => <th key={m} className="px-4 py-3 text-right">{m}</th>)}
                                        <th className="px-4 py-3 text-right font-bold text-zinc-300 border-l border-zinc-800">Total</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-zinc-800/50">
                                    <AnalysisRow label="Revenue" data={financials.revenue.total} />
                                    <AnalysisRow label="COGS" data={financials.cogs.acc} neg />
                                    <AnalysisRow label="Gross Margin" data={financials.revenue.total.map((r,i) => r - financials.cogs.acc[i])} bold />
                                    <AnalysisRow label="Staff" data={financials.opex.staff} neg />
                                    <AnalysisRow label="EBITDA" data={financials.pnl.ebitda} bold highlight />
                                    <AnalysisRow label="Net Result" data={financials.pnl.net} color="text-blue-400" />
                                    <AnalysisRow label="Cash Balance" data={financials.liquidity.balance} bold />
                                </tbody>
                            </table>
                        </div>
                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            {/* Break-even */}
                            <div className="bg-zinc-900/40 border border-zinc-800 p-4 rounded-xl">
                                <h3 className="text-sm font-bold mb-4 text-zinc-300">Break-even: EBITDA vs Net Result</h3>
                                <div className="h-60">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={analysisData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                            <XAxis dataKey="name" stroke="#52525b" fontSize={10} />
                                            <YAxis stroke="#52525b" fontSize={10} tickFormatter={(v) => `${v/1000}k`} />
                                            <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                            <ReferenceLine y={0} stroke="#666" />
                                            <Legend />
                                            <Line type="monotone" dataKey="EBITDA" stroke="#10b981" strokeWidth={2} dot={false} />
                                            <Line type="monotone" dataKey="NetResult" stroke="#3b82f6" strokeWidth={2} dot={false} />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Gross Margin % */}
                            <div className="bg-zinc-900/40 border border-zinc-800 p-4 rounded-xl">
                                <h3 className="text-sm font-bold mb-4 text-zinc-300">Gross Margin %</h3>
                                <div className="h-60">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={analysisData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                            <XAxis dataKey="name" stroke="#52525b" fontSize={10} />
                                            <YAxis stroke="#52525b" fontSize={10} domain={[0, 100]} />
                                            <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} formatter={(v) => v.toFixed(1)+'%'} />
                                            <Legend />
                                            <Line type="monotone" dataKey="GM" name="Gross Margin %" stroke="#f59e0b" strokeWidth={2} dot={false} />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Cost Distribution */}
                            <div className="bg-zinc-900/40 border border-zinc-800 p-4 rounded-xl">
                                <h3 className="text-sm font-bold mb-4 text-zinc-300">OPEX Distribution</h3>
                                <div className="h-60">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={analysisData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                            <XAxis dataKey="name" stroke="#52525b" fontSize={10} />
                                            <YAxis stroke="#52525b" fontSize={10} tickFormatter={(v) => `${v/1000}k`} />
                                            <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                            <Legend />
                                            <Area type="monotone" dataKey="Staff" stackId="1" stroke="#8b5cf6" fill="#8b5cf6" />
                                            <Area type="monotone" dataKey="Consultants" stackId="1" stroke="#ec4899" fill="#ec4899" />
                                            <Area type="monotone" dataKey="Cloud" stackId="1" stroke="#06b6d4" fill="#06b6d4" />
                                            <Area type="monotone" dataKey="Other" stackId="1" stroke="#64748b" fill="#64748b" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* ARR Progression */}
                            <div className="bg-zinc-900/40 border border-zinc-800 p-4 rounded-xl">
                                <h3 className="text-sm font-bold mb-4 text-zinc-300">Recurring Revenue (Monthly)</h3>
                                <div className="h-60">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={analysisData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                            <XAxis dataKey="name" stroke="#52525b" fontSize={10} />
                                            <YAxis stroke="#52525b" fontSize={10} tickFormatter={(v) => `${v/1000}k`} />
                                            <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                            <Area type="monotone" dataKey="ARR" stroke="#3b82f6" fill="#3b82f6" fillOpacity={0.3} />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Cash Runway */}
                            <div className="bg-zinc-900/40 border border-zinc-800 p-4 rounded-xl">
                                <h3 className="text-sm font-bold mb-4 text-zinc-300">Cash Runway (Liquidity)</h3>
                                <div className="h-60">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={analysisData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                            <XAxis dataKey="name" stroke="#52525b" fontSize={10} />
                                            <YAxis stroke="#52525b" fontSize={10} tickFormatter={(v) => `${v/1000}k`} />
                                            <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                            <ReferenceLine y={0} stroke="#666" />
                                            <Bar dataKey="Cash">
                                                {analysisData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.Cash < 0 ? '#ef4444' : '#10b981'} />
                                                ))}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Inventory Pressure */}
                            <div className="bg-zinc-900/40 border border-zinc-800 p-4 rounded-xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-sm font-bold text-zinc-300">Inventory Pressure</h3>
                                    <select 
                                        className="bg-zinc-800 border border-zinc-700 text-xs rounded px-2 py-1 outline-none"
                                        onChange={(e) => setSelectedInventoryItem(e.target.value)}
                                        value={selectedInventoryItem || ""}
                                    >
                                        {inventoryItems.map(i => <option key={i.id} value={i.id}>{i.name}</option>)}
                                    </select>
                                </div>
                                <div className="h-60">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={analysisData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                            <XAxis dataKey="name" stroke="#52525b" fontSize={10} />
                                            <YAxis stroke="#52525b" fontSize={10} />
                                            <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                            <Legend />
                                            <Bar dataKey="InvStock" name="Current Stock" fill="#6366f1" />
                                            <Line type="monotone" dataKey="InvDemandNext2M" name="Demand (Next 2M)" stroke="#f43f5e" strokeWidth={2} dot={false} />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                             {/* Headcount vs Cost */}
                             <div className="bg-zinc-900/40 border border-zinc-800 p-4 rounded-xl">
                                <h3 className="text-sm font-bold mb-4 text-zinc-300">Headcount vs Cost</h3>
                                <div className="h-60">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={analysisData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                            <XAxis dataKey="name" stroke="#52525b" fontSize={10} />
                                            <YAxis yAxisId="left" stroke="#52525b" fontSize={10} tickFormatter={(v) => `${v/1000}k`} />
                                            <YAxis yAxisId="right" orientation="right" stroke="#52525b" fontSize={10} />
                                            <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                            <Legend />
                                            <Bar yAxisId="right" dataKey="FTE" name="FTEs" fill="#3f3f46" barSize={20} />
                                            <Line yAxisId="left" type="monotone" dataKey="Staff" name="Staff Cost" stroke="#8b5cf6" strokeWidth={2} dot={false} />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Free Cash Flow */}
                            <div className="bg-zinc-900/40 border border-zinc-800 p-4 rounded-xl">
                                <h3 className="text-sm font-bold mb-4 text-zinc-300">Free Cash Flow (Monthly)</h3>
                                <div className="h-60">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={analysisData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" />
                                            <XAxis dataKey="name" stroke="#52525b" fontSize={10} />
                                            <YAxis stroke="#52525b" fontSize={10} tickFormatter={(v) => `${v/1000}k`} />
                                            <RechartsTooltip contentStyle={{ backgroundColor: '#18181b', borderColor: '#27272a' }} />
                                            <ReferenceLine y={0} stroke="#666" />
                                            <Line type="monotone" dataKey="FCF" stroke="#10b981" strokeWidth={2} dot={true} />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* --- MODALS --- */}
                {/* ... Modals (Product, Consultant, Role, OpCost, Loan, Equity) are unchanged ... */}
                {/* Omitted for brevity in diff view, but included in full file context if needed */}
                {editingProduct && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                        <div className="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-md shadow-2xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex items-center gap-4">
                                    <div className="w-20 h-20 bg-white rounded flex-shrink-0 flex items-center justify-center overflow-hidden border border-zinc-700">
                                        {editingProduct.img ? <img src={editingProduct.img} alt={editingProduct.name} className="w-full h-full object-contain p-1" /> : <Box className="text-zinc-400"/>}
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-lg">{editingProduct.name}</h3>
                                        <p className="text-xs text-zinc-500 uppercase">{editingProduct.type} Settings</p>
                                    </div>
                                </div>
                                <button onClick={() => setEditingProduct(null)} className="text-zinc-500 hover:text-white">
                                    <X size={20} />
                                </button>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Product Name</label>
                                    <input 
                                        type="text" 
                                        value={editingProduct.name} 
                                        onChange={(e) => setEditingProduct({...editingProduct, name: e.target.value})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 focus:ring-1 focus:ring-blue-500 outline-none text-zinc-200"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Start Cost (One-Off Revenue)</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-2 text-zinc-500 text-sm">kr</span>
                                        <input 
                                            type="number" 
                                            value={editingProduct.price} 
                                            onChange={(e) => setEditingProduct({...editingProduct, price: parseFloat(e.target.value) || 0})}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 pl-8 focus:ring-1 focus:ring-blue-500 outline-none"
                                        />
                                    </div>
                                </div>
                                
                                {editingProduct.type !== 'addon' && (
                                    <div>
                                        <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Recurring Cost (Monthly Sub)</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-2 text-zinc-500 text-sm">kr</span>
                                            <input 
                                                type="number" 
                                                value={editingProduct.sub} 
                                                onChange={(e) => setEditingProduct({...editingProduct, sub: parseFloat(e.target.value) || 0})}
                                                className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 pl-8 focus:ring-1 focus:ring-blue-500 outline-none"
                                            />
                                        </div>
                                    </div>
                                )}

                                <div className="pt-2 border-t border-zinc-800">
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Production Cost (COGS)</label>
                                    <p className="text-xs text-zinc-500 mb-2">Changing this will update all products sharing the "{editingProduct.baseId}" inventory ID.</p>
                                    <div className="relative">
                                        <span className="absolute left-3 top-2 text-zinc-500 text-sm">kr</span>
                                        <input 
                                            type="number" 
                                            value={editingProduct.cost} 
                                            onChange={(e) => setEditingProduct({...editingProduct, cost: parseFloat(e.target.value) || 0})}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 pl-8 focus:ring-1 focus:ring-rose-500 outline-none"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="flex gap-3 mt-8">
                                <button 
                                    onClick={() => handleDeleteProduct(editingProduct.id)}
                                    className="px-3 py-2 rounded bg-rose-900/30 hover:bg-rose-900/50 text-rose-400 border border-rose-900/50 transition"
                                    title="Delete Product"
                                >
                                    <Trash2 size={18} />
                                </button>
                                <button 
                                    onClick={() => setEditingProduct(null)}
                                    className="flex-1 px-4 py-2 rounded bg-zinc-800 hover:bg-zinc-700 text-sm font-medium transition"
                                >
                                    Cancel
                                </button>
                                <button 
                                    onClick={() => handleProductUpdate(editingProduct)}
                                    className="flex-1 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium transition"
                                >
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* --- MODAL: CONSULTANT SETTINGS --- */}
                {editingConsultant && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                        <div className="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-sm shadow-2xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-lg text-zinc-100">Edit Consultant</h3>
                                <button onClick={() => setEditingConsultant(null)} className="text-zinc-500 hover:text-white">
                                    <X size={20} />
                                </button>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Name</label>
                                    <input 
                                        type="text" 
                                        value={editingConsultant.name} 
                                        onChange={(e) => setEditingConsultant({...editingConsultant, name: e.target.value})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200 focus:ring-1 focus:ring-blue-500 outline-none"
                                    />
                                </div>
                                {/* Removed Monthly Rate Input as requested */}
                            </div>

                            <div className="flex gap-3 mt-8">
                                <button 
                                    onClick={() => handleDeleteConsultant(editingConsultant.id)}
                                    className="px-3 py-2 rounded bg-rose-900/30 hover:bg-rose-900/50 text-rose-400 border border-rose-900/50 transition"
                                >
                                    <Trash2 size={18} />
                                </button>
                                <button 
                                    onClick={() => handleConsultantUpdate(editingConsultant)}
                                    className="flex-1 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium transition"
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* --- MODAL: ROLE SETTINGS --- */}
                {editingRole && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                        <div className="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-sm shadow-2xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-lg text-zinc-100">Edit Role</h3>
                                <button onClick={() => setEditingRole(null)} className="text-zinc-500 hover:text-white">
                                    <X size={20} />
                                </button>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Role Name</label>
                                    <input 
                                        type="text" 
                                        value={editingRole.name} 
                                        onChange={(e) => setEditingRole({...editingRole, name: e.target.value})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200 focus:ring-1 focus:ring-blue-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Annual Salary (NOK)</label>
                                    <input 
                                        type="number" 
                                        value={editingRole.salary} 
                                        onChange={(e) => setEditingRole({...editingRole, salary: parseFloat(e.target.value) || 0})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200 focus:ring-1 focus:ring-blue-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Social Cost Factor</label>
                                    <input 
                                        type="number" 
                                        step="0.1"
                                        value={editingRole.social} 
                                        onChange={(e) => setEditingRole({...editingRole, social: parseFloat(e.target.value) || 0})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200 focus:ring-1 focus:ring-blue-500 outline-none"
                                    />
                                    <p className="text-[10px] text-zinc-500 mt-1">1.4 = 40% social costs (AGA, pension, etc)</p>
                                </div>
                            </div>

                            <div className="flex gap-3 mt-8">
                                <button 
                                    onClick={() => handleDeleteRole(editingRole.id)}
                                    className="px-3 py-2 rounded bg-rose-900/30 hover:bg-rose-900/50 text-rose-400 border border-rose-900/50 transition"
                                >
                                    <Trash2 size={18} />
                                </button>
                                <button 
                                    onClick={() => handleRoleUpdate(editingRole)}
                                    className="flex-1 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium transition"
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* --- MODAL: OP COST SETTINGS --- */}
                {editingOpCost && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                        <div className="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-sm shadow-2xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-lg text-zinc-100">Edit Cost</h3>
                                <button onClick={() => setEditingOpCost(null)} className="text-zinc-500 hover:text-white">
                                    <X size={20} />
                                </button>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Description</label>
                                    <input 
                                        type="text" 
                                        value={editingOpCost.name} 
                                        onChange={(e) => setEditingOpCost({...editingOpCost, name: e.target.value})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200 focus:ring-1 focus:ring-blue-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Monthly Cost (NOK)</label>
                                    <input 
                                        type="number" 
                                        value={editingOpCost.monthly} 
                                        onChange={(e) => setEditingOpCost({...editingOpCost, monthly: parseFloat(e.target.value) || 0})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200 focus:ring-1 focus:ring-blue-500 outline-none"
                                    />
                                </div>
                                <div className="flex items-center gap-3">
                                    <label className="text-sm text-zinc-300">Subject to VAT?</label>
                                    <button 
                                        onClick={() => setEditingOpCost({...editingOpCost, vat: !editingOpCost.vat})}
                                        className={`w-10 h-5 rounded-full relative transition-colors ${editingOpCost.vat ? 'bg-emerald-500' : 'bg-zinc-700'}`}
                                    >
                                        <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${editingOpCost.vat ? 'left-6' : 'left-1'}`}></div>
                                    </button>
                                </div>
                            </div>

                            <div className="flex gap-3 mt-8">
                                <button 
                                    onClick={() => handleDeleteOpCost(editingOpCost.id)}
                                    className="px-3 py-2 rounded bg-rose-900/30 hover:bg-rose-900/50 text-rose-400 border border-rose-900/50 transition"
                                >
                                    <Trash2 size={18} />
                                </button>
                                <button 
                                    onClick={() => handleOpCostUpdate(editingOpCost)}
                                    className="flex-1 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium transition"
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* --- MODAL: LOAN SETTINGS --- */}
                {editingLoan && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                        <div className="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-md shadow-2xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-lg text-zinc-100">Edit Loan</h3>
                                <button onClick={() => setEditingLoan(null)} className="text-zinc-500 hover:text-white">
                                    <X size={20} />
                                </button>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Loan Name</label>
                                    <input 
                                        type="text" 
                                        value={editingLoan.name} 
                                        onChange={(e) => setEditingLoan({...editingLoan, name: e.target.value})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Amount (NOK)</label>
                                        <input 
                                            type="number" 
                                            value={editingLoan.amount} 
                                            onChange={(e) => setEditingLoan({...editingLoan, amount: parseFloat(e.target.value) || 0})}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Start Month (0=Jan)</label>
                                        <input 
                                            type="number" 
                                            min="0" max="11"
                                            value={editingLoan.startMonth} 
                                            onChange={(e) => setEditingLoan({...editingLoan, startMonth: parseInt(e.target.value) || 0})}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                        />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Interest Rate (%)</label>
                                        <input 
                                            type="number" 
                                            step="0.1"
                                            value={editingLoan.interestRate} 
                                            onChange={(e) => setEditingLoan({...editingLoan, interestRate: parseFloat(e.target.value) || 0})}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Fee Rate (%)</label>
                                        <input 
                                            type="number" 
                                            step="0.1"
                                            value={editingLoan.feeRate} 
                                            onChange={(e) => setEditingLoan({...editingLoan, feeRate: parseFloat(e.target.value) || 0})}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                        />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Term (Years)</label>
                                        <input 
                                            type="number" 
                                            value={editingLoan.termYears} 
                                            onChange={(e) => setEditingLoan({...editingLoan, termYears: parseFloat(e.target.value) || 0})}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Grace Period (Months)</label>
                                        <input 
                                            type="number" 
                                            value={editingLoan.gracePeriod} 
                                            onChange={(e) => setEditingLoan({...editingLoan, gracePeriod: parseFloat(e.target.value) || 0})}
                                            className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                        />
                                    </div>
                                </div>
                                <div className="flex items-center gap-3 mt-2">
                                    <label className="text-sm text-zinc-300">Active?</label>
                                    <button 
                                        onClick={() => setEditingLoan({...editingLoan, active: !editingLoan.active})}
                                        className={`w-10 h-5 rounded-full relative transition-colors ${editingLoan.active ? 'bg-emerald-500' : 'bg-zinc-700'}`}
                                    >
                                        <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${editingLoan.active ? 'left-6' : 'left-1'}`}></div>
                                    </button>
                                </div>
                            </div>

                            <div className="flex gap-3 mt-8">
                                <button 
                                    onClick={() => handleDeleteLoan(editingLoan.id)}
                                    className="px-3 py-2 rounded bg-rose-900/30 hover:bg-rose-900/50 text-rose-400 border border-rose-900/50 transition"
                                >
                                    <Trash2 size={18} />
                                </button>
                                <button 
                                    onClick={() => handleLoanUpdate(editingLoan)}
                                    className="flex-1 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium transition"
                                >
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* --- MODAL: EQUITY SETTINGS --- */}
                {editingEquity && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                        <div className="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-sm shadow-2xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-lg text-zinc-100">Edit Equity Round</h3>
                                <button onClick={() => setEditingEquity(null)} className="text-zinc-500 hover:text-white">
                                    <X size={20} />
                                </button>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Description</label>
                                    <input 
                                        type="text" 
                                        value={editingEquity.name} 
                                        onChange={(e) => setEditingEquity({...editingEquity, name: e.target.value})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Amount (NOK)</label>
                                    <input 
                                        type="number" 
                                        value={editingEquity.amount} 
                                        onChange={(e) => setEditingEquity({...editingEquity, amount: parseFloat(e.target.value) || 0})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 uppercase mb-1">Month (0=Jan)</label>
                                    <input 
                                        type="number" 
                                        min="0" max="11"
                                        value={editingEquity.month} 
                                        onChange={(e) => setEditingEquity({...editingEquity, month: parseInt(e.target.value) || 0})}
                                        className="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-zinc-200"
                                    />
                                </div>
                            </div>

                            <div className="flex gap-3 mt-8">
                                <button 
                                    onClick={() => handleDeleteEquity(editingEquity.id)}
                                    className="px-3 py-2 rounded bg-rose-900/30 hover:bg-rose-900/50 text-rose-400 border border-rose-900/50 transition"
                                >
                                    <Trash2 size={18} />
                                </button>
                                <button 
                                    onClick={() => handleEquityUpdate(editingEquity)}
                                    className="flex-1 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium transition"
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                )}

            </main>
        </div>
    );
}

// ... Sub-components unchanged ...
function KpiCard({ title, value, sub, color }) {
    return (
        <div className="bg-zinc-900/40 border border-zinc-800 p-6 rounded-xl">
            <div className="text-zinc-500 text-xs font-bold uppercase tracking-wider mb-2">{title}</div>
            <div className={`text-2xl font-bold mb-1 ${color}`}>{value}</div>
            {sub && <div className="text-xs text-zinc-600">{sub}</div>}
        </div>
    );
}

function SummaryRow({ label, values, neg, bold, color, highlight, muted }) {
    const total = values.reduce((a,b)=>a+b,0);
    return (
        <tr className={`${highlight ? 'bg-zinc-800/30' : ''}`}>
            <td className={`px-6 py-3 font-medium ${muted ? 'text-zinc-600' : 'text-zinc-300'}`}>{label}</td>
            <td className={`px-6 py-3 text-right ${bold ? 'font-bold' : ''} ${color || (muted ? 'text-zinc-600' : (neg ? 'text-rose-400' : 'text-zinc-200'))}`}>
                {neg && total > 0 ? '-' : ''}{formatNum(total)}
            </td>
            <td className="px-6 py-3 text-right hidden sm:table-cell text-zinc-600">
                {formatNum(total/12)}
            </td>
        </tr>
    );
}

function AnalysisRow({ label, data, neg, bold, highlight, color }) {
    const total = data.reduce((a, b) => a + b, 0);
    return (
        <tr className={`hover:bg-zinc-800/20 ${highlight ? 'bg-zinc-800/10' : ''}`}>
            <td className={`px-4 py-2 sticky left-0 bg-zinc-950 font-medium ${bold ? 'text-white' : 'text-zinc-400'}`}>{label}</td>
            {data.map((v, i) => (
                <td key={i} className={`px-4 py-2 text-right ${color || (v < 0 || neg ? 'text-rose-400' : 'text-zinc-400')}`}>
                   {neg && v > 0 ? '-' : ''}{Math.round(v/1000)}k
                </td>
            ))}
            <td className={`px-4 py-2 text-right font-bold border-l border-zinc-800 ${color || (total < 0 || neg ? 'text-rose-400' : 'text-zinc-200')}`}>
                {neg && total > 0 ? '-' : ''}{Math.round(total/1000)}k
            </td>
        </tr>
    );
}
